{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load humanize %}

{% block page_title %}{{ page_title|default:"Operations Management" }}{% endblock %}

{% block content %}
    {# Tabs Navigation #}
    <div class="shrink-0 mb-2 sticky top-[4rem] h-fit bg-base-100 rounded shadow z-10">
        <div class="tabs max-w-7xl mx-auto">
        <a class="tab tab-lifted text-lg transition
           {% if active_tab == DEFAULT_CUSTOMER_ORDERS_TAB %}tab-active bg-blue-500 text-white{% else %}bg-gray-200 hover:bg-gray-300 text-gray-700{% endif %}"
           href="?tab={{ DEFAULT_CUSTOMER_ORDERS_TAB }}"
           data-tab-url="?tab={{ DEFAULT_CUSTOMER_ORDERS_TAB }}"
           data-tab="{{ DEFAULT_CUSTOMER_ORDERS_TAB }}">
            Customer Orders
        </a>
        <a class="tab tab-lifted text-lg transition
           {% if active_tab == DEFAULT_PARCELS_TAB %}tab-active bg-blue-500 text-white{% else %}bg-gray-200 hover:bg-gray-300 text-gray-700{% endif %}"
           href="?tab={{ DEFAULT_PARCELS_TAB }}"
           data-tab-url="?tab={{ DEFAULT_PARCELS_TAB }}"
           data-tab="{{ DEFAULT_PARCELS_TAB }}">
            Parcel Details
        </a>
        </div>
    </div>

    {# Dynamic Content Area for Tabs #}
    <div id="operation-tab-content">
        {% if active_tab == DEFAULT_CUSTOMER_ORDERS_TAB %}
            {% include 'operation/partials/customer_orders_table.html' %}
        {% elif active_tab == DEFAULT_PARCELS_TAB %}
            {% include 'operation/partials/parcels_table.html' %}
        {% else %}
            <p>Select a tab to view content.</p>
        {% endif %}
    </div>

{# MODAL HTML for Excel Import #}
<input type="checkbox" id="import-orders-modal-toggle" class="modal-toggle" />
<div class="modal" role="dialog">
  <div class="modal-box max-w-lg">
    <form method="post" enctype="multipart/form-data" action="{% url 'operation:import_orders_from_excel' %}">
        {% csrf_token %}
        <label for="import-orders-modal-toggle" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</label>
        <h3 class="font-bold text-xl mb-4">Import Orders via Excel</h3>
        <div class="form-control w-full mb-4">
            {{ import_form.excel_file.label_tag }}
            {{ import_form.excel_file }}
            {% if import_form.excel_file.help_text %}<label class="label"><span class="label-text-alt">{{ import_form.excel_file.help_text }}</span></label>{% endif %}
            {% for error in import_form.excel_file.errors %}<label class="label"><span class="label-text-alt text-error">{{ error }}</span></label>{% endfor %}
        </div>
        {% if import_form.non_field_errors %}
            <div class="alert alert-error shadow-sm mb-4">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span>{% for error in import_form.non_field_errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}</span>
                </div>
            </div>
        {% endif %}
        <div class="modal-action mt-6">
            <label for="import-orders-modal-toggle" class="btn btn-ghost">Cancel</label>
            <button type="submit" class="btn btn-primary">Upload and Process</button>
        </div>
    </form>
    <div class="divider mt-6 mb-2">Instructions</div>
    <div class="prose prose-sm max-w-none text-xs">
        <p>Ensure your Excel file (.xlsx or .xls) follows this format:</p>
        <ul><li>First sheet, first row must be headers.</li><li>Each row is one order item. Repeat order details for multiple items in one order.</li></ul>
        <p><strong>Expected Columns:</strong> <code>Order ID</code>, <code>Order Date</code> (YYYY-MM-DD or Month D,YYYY), <code>Address Name</code> (as Customer), <code>Product Name</code> (as SKU or Name), <code>Product Quantity</code>, <code>Warehouse Name</code>. Other columns like <code>Company</code>, <code>Address</code>, <code>isCold</code>, etc., will also be processed if present and mapped.</p>
    </div>
  </div>
  <label class="modal-backdrop" for="import-orders-modal-toggle">Close</label>
</div>

{# Pack Order Modal #}
<input type="checkbox" id="pack-order-modal-toggle" class="modal-toggle" />
<div class="modal" role="dialog" id="pack-order-modal-container">
    <div class="modal-box max-w-3xl">
        <label for="pack-order-modal-toggle" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 modal-close-button">✕</label>
        <h3 class="font-bold text-xl mb-1" id="pack-modal-title">Pack Order</h3>
        <p class="text-sm text-gray-500 mb-4" id="pack-modal-customer"></p>

        <form id="pack-order-form" method="POST">
            {% csrf_token %}
            <input type="hidden" name="order_pk_for_packing" id="order_pk_for_packing_modal_hidden_id">
            <input type="hidden" name="order_is_cold_chain" id="order_is_cold_chain_hidden_id">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 mb-4">
                <div class="border p-3 rounded-md bg-gray-50">
                    {# NEW: Daily Courier Counts Display #}
                    <div id="daily-courier-counts-display" class="mb-3">
                        <h4 class="text-sm font-semibold text-gray-700 mb-1">Today's Couriers:</h4>
                        {# Updated UL for dashboard layout #}
                        <ul class="flex flex-wrap gap-3" id="courier-counts-list">
                            {# Content will be populated by JavaScript #}
                            {# Example of one item's structure (for reference, JS will create this):
                            <li class="border border-gray-300 p-3 rounded-lg text-center bg-white shadow-sm min-w-[100px]">
                                <span class="block text-xs font-semibold text-gray-700">DHL</span>
                                <span class="block text-2xl font-bold text-gray-800 mt-1">15</span>
                            </li>
                            #}
                        </ul>
                    </div>
                    {# END NEW #}

                    <label class="label"><span class="label-text font-semibold">Select Courier</span></label>
                    <div class="flex flex-wrap gap-2" id="courier-selection-buttons">
                        <button type="button" class="btn btn-sm btn-outline courier-btn" data-courier="DHL_CH">DHL-CH</button>
                        <button type="button" class="btn btn-sm btn-outline courier-btn" data-courier="DHL_AY">DHL-AY</button>
                        <button type="button" class="btn btn-sm btn-outline courier-btn" data-courier="Fedex">Fedex</button>
                        <button type="button" class="btn btn-sm btn-outline courier-btn" data-courier="UPS">UPS</button>
                    </div>
                    <input type="hidden" name="parcel-courier_name" id="id_parcel-courier_name">


                </div>

                <div class="border p-3 rounded-md bg-gray-50 mt-4 md:mt-0">
                    <div class="mb-2">
                        <h4 class="text-sm font-semibold text-gray-700">Order Requirement:</h4>
                            <span id="order-cold-chain-status-display" class="font-bold">Loading...</span>
                    </div>

                    <label class="label"><span class="label-text font-semibold">Select Packaging</span></label>

                    <div id="packaging-iscold-options" class="mb-2">
                        <div class="flex flex-wrap gap-2 mt-1">
                            <button type="button" class="btn btn-sm btn-outline packaging-btn" data-packaging="FOAM_BOX_A1">Foam Box A1</button>
                            <button type="button" class="btn btn-sm btn-outline packaging-btn" data-packaging="FOAM_BOX_PLUS">Foam Box +Amb</button>
                        </div>
                    </div>

                    <div id="packaging-ambient-options">
                        <div class="flex flex-wrap gap-2 mt-1">
                            <button type="button" class="btn btn-sm btn-outline packaging-btn" data-packaging="FLYER_S">Flyer S</button>
                            <button type="button" class="btn btn-sm btn-outline packaging-btn" data-packaging="FLYER_M">Flyer M</button>
                            <button type="button" class="btn btn-sm btn-outline packaging-btn" data-packaging="FLYER_L">Flyer L</button>
                        </div>
                    </div>

                    <input type="hidden" name="parcel-packaging_type" id="id_parcel-packaging_type">
                </div>
            </div>

            <div class="mt-3">
                <label class="label" for="id_parcel-notes"><span class="label-text font-semibold">Parcel Notes</span></label>
                <textarea name="parcel-notes" id="id_parcel-notes" class="textarea textarea-bordered textarea-sm w-full" rows="2"></textarea>
            </div>

            <h4 class="text-md font-semibold mb-2">Items to Pack:</h4>
            <div id="pack-order-items-formset-container" class="mb-4 max-h-60 overflow-y-auto">
                <p class="text-center py-4 text-gray-400">Loading items...</p>
            </div>
            <div class="modal-action mt-12">
                <label for="pack-order-modal-toggle" class="btn btn-ghost modal-close-button">Cancel</label>
                <button type="submit" class="btn btn-primary">Create Parcel & Pack Items</button>
            </div>
        </form>
    </div>
    <label class="modal-backdrop modal-close-button" for="pack-order-modal-toggle">Close</label>
</div>


{# Edit Order Modal #}
<input type="checkbox" id="edit-order-modal-toggle" class="modal-toggle" />
<div class="modal" role="dialog" id="edit-order-modal-container">
    <div class="modal-box max-w-3xl">
        <label for="edit-order-modal-toggle" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 modal-close-button">✕</label>
        <h3 class="font-bold text-xl mb-1" id="edit-modal-title">Edit Order Items</h3>
        <p class="text-sm text-gray-500 mb-4" id="edit-modal-customer-info">Customer: </p>
        <form id="edit-order-form" method="POST"> {% csrf_token %}
            <input type="hidden" name="order_pk_for_editing" id="order_pk_for_editing_modal_hidden_id_js">

            <h4 class="text-md font-semibold mb-2">Items with Balance to Pack:</h4>
            <div id="edit-order-items-formset-container" class="mb-4 max-h-60 overflow-y-auto">
                <p class="text-center py-4 text-gray-400">Loading items...</p>
            </div>

            <div id="removed-items-log-container" class="mt-4">
                <h4 class="text-md font-semibold mb-2">Previously Removed Items:</h4>
                <div id="removed-items-display" class="text-xs text-gray-600 bg-gray-50 p-2 rounded max-h-28 overflow-y-auto">
                    <p>No items previously removed for this order.</p>
                </div>
            </div>

            <div class="modal-action mt-6">
                <label for="edit-order-modal-toggle" class="btn btn-ghost modal-close-button">Cancel</label>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
    <label class="modal-backdrop modal-close-button-edit" for="edit-order-modal-toggle">Close</label>
</div>


{% endblock %}

{% block extra_js %}
<script>
    const CSRF_TOKEN_INPUT = document.querySelector('input[name="csrfmiddlewaretoken"]');
    const CSRF_TOKEN = CSRF_TOKEN_INPUT ? CSRF_TOKEN_INPUT.value : '';
    const DEFAULT_CUSTOMER_ORDERS_TAB = "{{ DEFAULT_CUSTOMER_ORDERS_TAB|escapejs }}";
    const DEFAULT_PARCELS_TAB = "{{ DEFAULT_PARCELS_TAB|escapejs }}";
    const currentBaseUrl = "{% url 'operation:order_list' %}";

    console.log(`[Global JS Init] DEFAULT_CUSTOMER_ORDERS_TAB: '${DEFAULT_CUSTOMER_ORDERS_TAB}'`);
    console.log(`[Global JS Init] DEFAULT_PARCELS_TAB: '${DEFAULT_PARCELS_TAB}'`);
    console.log(`[Global JS Init] currentBaseUrl: '${currentBaseUrl}'`);

document.addEventListener('DOMContentLoaded', function() {
    const tabContainer = document.getElementById('operation-tab-content');
    const mainPageTabs = document.querySelectorAll('.tabs a.tab');
    const ORDER_MGMT_TAB_SPECIFIC_PARAMS = {
        '{{ DEFAULT_CUSTOMER_ORDERS_TAB|escapejs }}': ['warehouse', 'status', 'q', 'page'],
        '{{ DEFAULT_PARCELS_TAB|escapejs }}': ['parcel_warehouse', 'parcel_courier', 'parcel_q', 'page'] // Added parcel_courier
    };
    const DEFAULT_ORDER_MGMT_TAB = "{{ DEFAULT_CUSTOMER_ORDERS_TAB|escapejs }}";

    let currentCustomerOrderFilters = { page: '1' };
    let currentParcelFilters = { page: '1', parcel_warehouse: '', parcel_courier: '', parcel_q: '' }; // Initialize parcel_courier
    let isFetchingCustomerOrders = false;
    let isFetchingParcels = false;

    function debounce(func, delay) {
        let timeout;
        const debounced = function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
        debounced.cancel = () => { clearTimeout(timeout); };
        return debounced;
    }

    function getCsrfToken() {
        return CSRF_TOKEN || (document.querySelector('input[name="csrfmiddlewaretoken"]') ? document.querySelector('input[name="csrfmiddlewaretoken"]').value : '');
    }

    // Definition of displayCourierDashboard
    function displayCourierDashboard(courierData = {}) {
        const listElement = document.getElementById('courier-counts-list');
        if (!listElement) {
            console.error('Element with ID "courier-counts-list" not found for dashboard.');
            return;
        }

        listElement.innerHTML = ''; // Clear previous items

        if (Object.keys(courierData).length === 0) {
            const messageItem = document.createElement('li');
            messageItem.textContent = 'No courier data to display.';
            // Applying some basic Tailwind classes for the message. Adjust as needed.
            messageItem.className = 'text-sm text-gray-500 py-2';
            listElement.appendChild(messageItem);
            return;
        }

        for (const courierName in courierData) {
            if (courierData.hasOwnProperty(courierName)) {
                const count = courierData[courierName];

                const listItem = document.createElement('li');
                listItem.className = 'border border-gray-300 p-1 rounded-lg text-center bg-white shadow-sm min-w-16';

                const nameElement = document.createElement('span');
                nameElement.textContent = courierName;
                nameElement.className = 'block text-xs font-semibold text-gray-700';

                const countElement = document.createElement('span');
                countElement.textContent = count;
                countElement.className = 'block text-2xl font-bold text-gray-800 mt-1';

                listItem.appendChild(nameElement);
                listItem.appendChild(countElement);
                listElement.appendChild(listItem);
            }
        }
    }


    function getCurrentTabNameFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('tab') || DEFAULT_ORDER_MGMT_TAB;
    }

    function saveTabFiltersToSession(tabName, filterState) {
        const paramsForStorage = new URLSearchParams();
        const allowedParams = ORDER_MGMT_TAB_SPECIFIC_PARAMS[tabName] || [];
        const sourceObject = (filterState instanceof URLSearchParams) ? Object.fromEntries(filterState.entries()) : filterState;

        allowedParams.forEach(key => {
            if (sourceObject.hasOwnProperty(key) && sourceObject[key]) {
                if (key === 'page' && sourceObject[key] === '1') {
                    // No change needed here, was already fine
                } else {
                    paramsForStorage.set(key, sourceObject[key]);
                }
            }
        });
        const paramsString = paramsForStorage.toString();
        sessionStorage.setItem(`tabFilters_${tabName}`, paramsString);
        console.log(`[saveTabFiltersToSession] Saved for tab '${tabName}': '${paramsString}'`, JSON.parse(JSON.stringify(filterState)));
    }

    function loadTabFiltersFromSession(tabName) {
        const storedParamsString = sessionStorage.getItem(`tabFilters_${tabName}`);
        console.log(`[loadTabFiltersFromSession] Loaded for tab '${tabName}': '${storedParamsString}'`);
        const params = new URLSearchParams(storedParamsString || '');
        if (!params.has('page')) {
            params.set('page', '1');
        }
        return params;
    }

    function clearTabFiltersFromSession(tabName) {
         sessionStorage.removeItem(`tabFilters_${tabName}`);
         console.log(`[clearTabFiltersFromSession] Cleared filters for tab '${tabName}'`);
    }
    function clearAllTabFiltersFromSession() {
        for (const tabName in ORDER_MGMT_TAB_SPECIFIC_PARAMS) {
            sessionStorage.removeItem(`tabFilters_${tabName}`);
        }
        console.log(`[clearAllTabFiltersFromSession] All tab filters cleared from session.`);
    }

    function updateCustomerOrderFiltersUI() {
        const currentTabContent = document.getElementById('operation-tab-content');
        if (!currentTabContent) return;
        const filterPanel = currentTabContent.querySelector('.operations-filter-panel');
        if (!filterPanel || !currentTabContent.querySelector('#customer-orders-list-tbody')) {
            return;
        }

        const activeWarehouse = currentCustomerOrderFilters.warehouse || "";
        filterPanel.querySelectorAll('.warehouse-filter-btn').forEach(btn => {
            if (btn.dataset.value === activeWarehouse) {
                btn.classList.add('btn-neutral', 'text-white'); btn.classList.remove('btn-outline');
            } else {
                btn.classList.remove('btn-neutral', 'text-white'); btn.classList.add('btn-outline');
            }
        });
        const activeStatus = currentCustomerOrderFilters.status || "";
        filterPanel.querySelectorAll('.status-filter-btn').forEach(btn => {
            if (btn.dataset.value === activeStatus) {
                btn.classList.add('btn-neutral', 'text-white'); btn.classList.remove('btn-outline');
            } else {
                btn.classList.remove('btn-neutral', 'text-white'); btn.classList.add('btn-outline');
            }
        });
        const searchInput = filterPanel.querySelector('.dynamic-search-input');
        if (searchInput) {
             if (searchInput.value !== (currentCustomerOrderFilters.q || "")) {
                searchInput.value = currentCustomerOrderFilters.q || "";
            }
        }

        const orderCountSpan = filterPanel.querySelector('.customer-order-count');
         if (orderCountSpan && currentCustomerOrderFilters.total_orders_count !== undefined) {
            orderCountSpan.textContent = `(${currentCustomerOrderFilters.total_orders_count} orders)`;
        }
        console.log("[updateCustomerOrderFiltersUI] Customer order filter UI updated.");
    }

    function loadInitialCustomerOrderFilters(urlParams) {
        currentCustomerOrderFilters.warehouse = urlParams.get('warehouse') || "";
        currentCustomerOrderFilters.status = urlParams.get('status') || "";
        currentCustomerOrderFilters.q = urlParams.get('q') || "";
        currentCustomerOrderFilters.page = urlParams.get('page') || '1';
        console.log("[loadInitialCustomerOrderFilters] Initialized currentCustomerOrderFilters:", JSON.parse(JSON.stringify(currentCustomerOrderFilters)));
        updateCustomerOrderFiltersUI();
    }

    function applyCustomerOrderFilters(resetPage = true, caller="unknown") {
        if (isFetchingCustomerOrders) {
            console.log(`[applyCustomerOrderFilters BY ${caller}] Already fetching, request ignored.`);
            return;
        }
        isFetchingCustomerOrders = true;
        console.log(`[applyCustomerOrderFilters BY ${caller}] resetPage: ${resetPage}. Setting isFetchingCustomerOrders = true.`);


        if (resetPage) {
            currentCustomerOrderFilters.page = '1';
        }
        console.log("[applyCustomerOrderFilters] Applying with filters:", JSON.parse(JSON.stringify(currentCustomerOrderFilters)));

        const paramsForHistory = new URLSearchParams();
        paramsForHistory.set('tab', DEFAULT_CUSTOMER_ORDERS_TAB);
        if (currentCustomerOrderFilters.warehouse) paramsForHistory.set('warehouse', currentCustomerOrderFilters.warehouse);
        if (currentCustomerOrderFilters.status) paramsForHistory.set('status', currentCustomerOrderFilters.status);
        if (currentCustomerOrderFilters.q) paramsForHistory.set('q', currentCustomerOrderFilters.q);
        if (currentCustomerOrderFilters.page && currentCustomerOrderFilters.page !== '1') {
            paramsForHistory.set('page', currentCustomerOrderFilters.page);
        } else if (paramsForHistory.has('page')) {
             paramsForHistory.delete('page');
        }

        const historyUrl = `${currentBaseUrl}?${paramsForHistory.toString()}`;

        const paramsForFetch = new URLSearchParams();
        paramsForFetch.set('tab', DEFAULT_CUSTOMER_ORDERS_TAB);
        if (currentCustomerOrderFilters.warehouse) paramsForFetch.set('warehouse', currentCustomerOrderFilters.warehouse);
        if (currentCustomerOrderFilters.status) paramsForFetch.set('status', currentCustomerOrderFilters.status);
        if (currentCustomerOrderFilters.q) paramsForFetch.set('q', currentCustomerOrderFilters.q);
        if (currentCustomerOrderFilters.page) paramsForFetch.set('page', currentCustomerOrderFilters.page);

        paramsForFetch.set('fetch_dynamic_content_only', 'true');
        const fetchUrl = `${currentBaseUrl}?${paramsForFetch.toString()}`;

        const dynamicContentContainer = document.getElementById('customer-orders-dynamic-content');

        if (dynamicContentContainer) {
            dynamicContentContainer.innerHTML = '<div class="text-center py-10"><span class="loading loading-dots loading-lg"></span> [JS Loading Orders...]</div>';
        } else {
            console.error("CRITICAL: #customer-orders-dynamic-content not found for replacement.");
            isFetchingCustomerOrders = false;
            return;
        }

        history.pushState({path: historyUrl, tab: DEFAULT_CUSTOMER_ORDERS_TAB}, '', historyUrl);
        saveTabFiltersToSession(DEFAULT_CUSTOMER_ORDERS_TAB, currentCustomerOrderFilters);

        fetch(fetchUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok for customer orders table refresh.');
                const totalCountHeader = response.headers.get('X-Total-Orders-Count');
                if (totalCountHeader !== null) {
                    currentCustomerOrderFilters.total_orders_count = totalCountHeader;
                }
                const hxTrigger = response.headers.get('HX-Trigger-After-Swap');
                if (hxTrigger === 'loadMoreCustomerOrdersUnavailable') {
                    const loadMoreContainer = document.getElementById('load-more-customer-orders-container');
                    if (loadMoreContainer) loadMoreContainer.style.display = 'none';
                } else if (hxTrigger === 'loadMoreCustomerOrdersAvailable') {
                     const loadMoreContainer = document.getElementById('load-more-customer-orders-container');
                    if (loadMoreContainer) loadMoreContainer.style.display = '';
                }
                return response.text();
            })
            .then(html => {
                if (dynamicContentContainer) {
                    dynamicContentContainer.innerHTML = html;
                    initializePackOrderButtons();
                    initializeEditOrderButtons();
                    initLoadMoreCustomerOrders();
                }
                updateCustomerOrderFiltersUI();
                 console.log("[applyCustomerOrderFilters] Customer orders table refreshed and JS re-initialized.");
            })
            .catch(error => {
                console.error('Failed to refresh customer orders table:', error);
                if (dynamicContentContainer) dynamicContentContainer.innerHTML = '<div class="text-center py-10 text-red-500">Error loading orders.</div>';
                const orderCountSpan = document.querySelector('#operation-tab-content .operations-filter-panel .customer-order-count');
                if (orderCountSpan) orderCountSpan.textContent = '(Error)';
            })
            .finally(() => {
                isFetchingCustomerOrders = false;
                console.log(`[applyCustomerOrderFilters FINALLY BY ${caller}] Setting isFetchingCustomerOrders = false.`);
            });
    }
    const debouncedApplyCustomerOrderFilters = debounce(applyCustomerOrderFilters, 400);

    function bindCustomerOrderFilterControls() {
        const currentTabContent = document.getElementById('operation-tab-content');
        if (!currentTabContent) {
            console.warn("[bindCustomerOrderFilterControls] #operation-tab-content not found.");
            return;
        }
        const filterPanel = currentTabContent.querySelector('.operations-filter-panel');

        if (!filterPanel || !currentTabContent.querySelector('#customer-orders-list-tbody')) {
            console.warn("[bindCustomerOrderFilterControls] Not binding: specific filter panel or tbody for customer orders not found in current #operation-tab-content.");
            return;
        }
        if (filterPanel.dataset.customerOrderFilterBound === 'true') {
            console.log("[bindCustomerOrderFilterControls] Already bound to this specific panel instance:", filterPanel);
            return;
        }

        filterPanel.addEventListener('click', function(event) {
            const target = event.target.closest('button');
            if (!target || !target.closest('.operations-filter-panel')) return;

            let filtersChanged = false;
            if (target.classList.contains('warehouse-filter-btn')) {
                currentCustomerOrderFilters.warehouse = target.dataset.value; filtersChanged = true;
            } else if (target.classList.contains('status-filter-btn')) {
                currentCustomerOrderFilters.status = target.dataset.value; filtersChanged = true;
            } else if (target.classList.contains('reset-filters-btn')) {
                currentCustomerOrderFilters = { page: '1' };
                const searchInput = filterPanel.querySelector('.dynamic-search-input');
                if (searchInput) searchInput.value = "";
                filtersChanged = true;
                clearTabFiltersFromSession(DEFAULT_CUSTOMER_ORDERS_TAB);
            }
            if (filtersChanged) {
                applyCustomerOrderFilters(true, "CO Button Click");
            }
        });

        const searchInput = filterPanel.querySelector('.dynamic-search-input');
        if (searchInput && !searchInput.dataset.coListenerAttached) {
            searchInput.addEventListener('input', function() {
                if (!this.closest('.operations-filter-panel') || this.closest('.parcel-filters')) return;
                console.log("[CustomerOrderSearchInput] User typed:", this.value);
                currentCustomerOrderFilters.q = this.value.trim();
                debouncedApplyCustomerOrderFilters(true, "CO Search Input");
            });
            searchInput.dataset.coListenerAttached = 'true';
        }
        filterPanel.dataset.customerOrderFilterBound = 'true';
        console.log("[bindCustomerOrderFilterControls] Customer order filter controls bound to specific panel:", filterPanel);
    }

    function initLoadMoreCustomerOrders() {
        const currentTabContent = document.getElementById('operation-tab-content');
        if (!currentTabContent) return;

        const loadMoreBtn = currentTabContent.querySelector('#explore-more-customer-orders-btn');
        const loadMoreContainer = currentTabContent.querySelector('#load-more-customer-orders-container');
        const ordersTbody = currentTabContent.querySelector('#customer-orders-list-tbody');

        if (!loadMoreBtn || !loadMoreContainer || !ordersTbody) {
            if(loadMoreContainer) loadMoreContainer.style.display = 'none';
            return;
        }
        if (loadMoreBtn.dataset.coListenerAttached === 'true') {
            return;
        }

        loadMoreBtn.addEventListener('click', function() {
            let currentPage = parseInt(currentCustomerOrderFilters.page || '1');
            const nextPage = currentPage + 1;
            console.log(`[LoadMoreCustomerOrders Click] Current page: ${currentPage}, Fetching next: ${nextPage}`);

            const params = new URLSearchParams();
            if (currentCustomerOrderFilters.warehouse) params.set('warehouse', currentCustomerOrderFilters.warehouse);
            if (currentCustomerOrderFilters.status) params.set('status', currentCustomerOrderFilters.status);
            if (currentCustomerOrderFilters.q) params.set('q', currentCustomerOrderFilters.q);
            params.set('page', nextPage.toString());

            const fetchUrl = `/operation/customer-orders/load-more/?${params.toString()}`;

            loadMoreBtn.disabled = true;
            loadMoreBtn.innerHTML = '<span class="loading loading-spinner"></span> Loading More Orders...';

            fetch(fetchUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
            .then(response => {
                const trigger = response.headers.get('HX-Trigger');
                if (!response.ok) throw new Error('Network response was not ok for loading more customer orders.');
                return response.text().then(html => ({html, trigger}));
            })
            .then(({html, trigger}) => {
                if (html.trim() !== "") {
                    ordersTbody.insertAdjacentHTML('beforeend', html);
                    currentCustomerOrderFilters.page = nextPage.toString();
                    saveTabFiltersToSession(DEFAULT_CUSTOMER_ORDERS_TAB, currentCustomerOrderFilters);
                    initializePackOrderButtons();
                    initializeEditOrderButtons();
                }

                if (trigger === 'loadMoreCustomerOrdersAvailable') {
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.innerHTML = 'Explore More Orders';
                    if(loadMoreContainer) loadMoreContainer.style.display = '';
                } else {
                    if(loadMoreContainer) loadMoreContainer.style.display = 'none';
                }
            })
            .catch(error => {
                console.error("Failed to load more customer orders:", error);
                if(loadMoreContainer) loadMoreContainer.style.display = 'none';
            })
            .finally(() => {
                if (loadMoreContainer && loadMoreContainer.style.display !== 'none') {
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.innerHTML = 'Explore More Orders';
                }
            });
        });
        loadMoreBtn.dataset.coListenerAttached = 'true';
    }

    function setupDynamicBatchDropdowns() {
        document.querySelectorAll('.pack-items-table .pack-item-row').forEach(row => {
            const orderItemId = row.dataset.orderItemId;
            const batchSelect = row.querySelector('.available-batches-select');
            const hiddenSelectedBatchIdInput = row.querySelector('input[name$="-selected_batch_item_id"]');
            const initialSuggestedBatchId = hiddenSelectedBatchIdInput ? hiddenSelectedBatchIdInput.value : null;
            const errorPlaceholder = row.querySelector('.available-batches-error-placeholder');

            if (!orderItemId || !batchSelect || !hiddenSelectedBatchIdInput) {
                return;
            }

            batchSelect.innerHTML = '<option value="">Loading batches...</option>';
            if (errorPlaceholder) errorPlaceholder.textContent = '';

            fetch(`/operation/order-item/${orderItemId}/get-available-batches/`)
                .then(response => {
                    if (!response.ok) {
                        return response.json().catch(() => response.text()).then(errDataOrText => {
                            let errMsg = `Error ${response.status}: `;
                            if (typeof errDataOrText === 'object' && errDataOrText.message) { errMsg += errDataOrText.message;
                            } else if (typeof errDataOrText === 'string') {
                                if (errDataOrText.trim().toLowerCase().startsWith('<!doctype html') || errDataOrText.trim().startsWith('<html')) {
                                    errMsg += `Server returned an HTML error page.`;
                                } else { errMsg += errDataOrText.substring(0, 150); }
                            } else { errMsg += response.statusText; }
                            throw new Error(errMsg);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    batchSelect.innerHTML = '<option value="">--- Select Batch ---</option>';
                    if (data.success && data.batches && data.batches.length > 0) {
                        data.batches.forEach(batch => {
                            const option = document.createElement('option');
                            option.value = batch.id;
                            option.textContent = batch.display_name;
                            batchSelect.appendChild(option);
                        });
                        if (initialSuggestedBatchId && batchSelect.querySelector(`option[value="${initialSuggestedBatchId}"]`)) {
                            batchSelect.value = initialSuggestedBatchId;
                            if (hiddenSelectedBatchIdInput) hiddenSelectedBatchIdInput.value = initialSuggestedBatchId;
                        } else if (initialSuggestedBatchId) {
                            if (hiddenSelectedBatchIdInput) hiddenSelectedBatchIdInput.value = '';
                            if (errorPlaceholder) errorPlaceholder.textContent = 'Note: Suggested batch not in current available list.';
                        }
                    } else {
                        const message = data.message || 'No batches available.';
                        batchSelect.innerHTML = `<option value="">${message}</option>`;
                        if (errorPlaceholder) errorPlaceholder.textContent = message;
                    }
                })
                .catch(error => {
                    console.error(`Error fetching batches for order item ${orderItemId}:`, error);
                    batchSelect.innerHTML = '<option value="">Error loading</option>';
                    if (errorPlaceholder) errorPlaceholder.textContent = `Client-side error: ${error.message}`;
                });

            if (!batchSelect.dataset.listenerAttachedBatchChange) {
                batchSelect.addEventListener('change', function() {
                    if (hiddenSelectedBatchIdInput) {
                        hiddenSelectedBatchIdInput.value = this.value;
                    }
                });
                batchSelect.dataset.listenerAttachedBatchChange = 'true';
            }
        });
    }
    function initializePackOrderButtons() {
        const currentTabContent = document.getElementById('operation-tab-content');
        if (!currentTabContent) { return; }

        currentTabContent.querySelectorAll('.pack-order-btn').forEach(button => {
            if (button.dataset.listenerAttached === 'true') return;
            button.addEventListener('click', function(event) {
                event.preventDefault();
                const orderPk = this.dataset.orderPk;
                if (!orderPk) { return; }
                const packModalToggle = document.getElementById('pack-order-modal-toggle');
                const packFormsetContainer = document.getElementById('pack-order-items-formset-container');
                const packModalTitle = document.getElementById('pack-modal-title');
                const packModalCustomer = document.getElementById('pack-modal-customer');
                const packForm = document.getElementById('pack-order-form');
                const orderPkHiddenInput = document.getElementById('order_pk_for_packing_modal_hidden_id');
                // Elements for courier counts
                const dailyCourierCountsDisplay = document.getElementById('daily-courier-counts-display');
                const courierCountsList = document.getElementById('courier-counts-list');


                if (!packModalToggle || !packFormsetContainer || !packModalTitle || !packModalCustomer || !packForm || !orderPkHiddenInput || !dailyCourierCountsDisplay || !courierCountsList) {
                    console.error("One or more Pack Order Modal elements are missing from the DOM.");
                    return;
                }
                packFormsetContainer.innerHTML = '<p class="text-center py-4 text-gray-400">Fetching items...</p>';
                // Clear previous courier counts and hide display initially
                courierCountsList.innerHTML = ''; // This will be populated by displayCourierDashboard
                dailyCourierCountsDisplay.style.display = 'none'; // Hide until data is available


                fetch(`/operation/order/${orderPk}/get-packing-items/`)
                    .then(response => {
                        const contentType = response.headers.get("content-type");
                        if (!response.ok) {
                            if (contentType && contentType.indexOf("application/json") !== -1) {
                                return response.json().then(errData => { throw new Error(errData.message || `Server error: ${response.status}`); });
                            } else {
                                return response.text().then(text => {
                                    if (text.trim().startsWith('<')) { throw new Error(`Unexpected HTML response (status: ${response.status}).`);}
                                    throw new Error(text || `Server error: ${response.status}`);
                                });
                            }
                        }
                        if (contentType && contentType.indexOf("application/json") !== -1) { return response.json(); }
                        else { throw new Error("Unexpected non-JSON response."); }
                    })
                    .then(data => {
                        if (data.success) {
                            if (packModalTitle) packModalTitle.textContent = `Pack Order: ${data.erp_order_id || orderPk}`;
                            if (packModalCustomer) packModalCustomer.textContent = `Customer: ${data.customer_name || 'N/A'}`;
                            if (packFormsetContainer) packFormsetContainer.innerHTML = data.formset_html;
                            if (packForm) packForm.action = `/operation/order/${orderPk}/process-packing/`;
                            if (orderPkHiddenInput) orderPkHiddenInput.value = orderPk;
                            const isColdOrderFromServer = data.is_cold_chain === true;
                            const coldChainStatusDisplayEl = document.getElementById('order-cold-chain-status-display');
                            const packagingIscoldOptionsEl = document.getElementById('packaging-iscold-options');
                            const packagingAmbientOptionsEl = document.getElementById('packaging-ambient-options');
                            if (coldChainStatusDisplayEl) {
                                coldChainStatusDisplayEl.textContent = isColdOrderFromServer ? "Cold Chain" : "Ambient";
                                coldChainStatusDisplayEl.className = isColdOrderFromServer ? "font-bold text-blue-600" : "font-bold text-green-600";
                            }
                            if (packagingIscoldOptionsEl && packagingAmbientOptionsEl) {
                                packagingIscoldOptionsEl.style.display = isColdOrderFromServer ? '' : 'none';
                                packagingAmbientOptionsEl.style.display = isColdOrderFromServer ? 'none' : '';
                            }
                            const hiddenCourierInput = document.getElementById('id_parcel-courier_name');
                            if(hiddenCourierInput) hiddenCourierInput.value = '';
                            document.querySelectorAll('#courier-selection-buttons .courier-btn').forEach(btn => { btn.classList.remove('btn-active'); btn.classList.add('btn-outline');});

                            const parcelNotesTextarea = document.getElementById('id_parcel-notes');
                            if (parcelNotesTextarea) {
                                parcelNotesTextarea.value = data.shipping_notes_for_parcel || '';
                            }

                            const hiddenPackagingInput = document.getElementById('id_parcel-packaging_type');
                            if(hiddenPackagingInput) hiddenPackagingInput.value = '';
                            document.querySelectorAll('.packaging-btn').forEach(btn => {btn.classList.remove('btn-active', 'btn-neutral'); btn.classList.add('btn-outline');});
                            if (typeof setupDynamicBatchDropdowns === "function") setupDynamicBatchDropdowns();
                            if (packModalToggle) packModalToggle.checked = true;

                            // MODIFIED: Populate daily courier counts using the dashboard function
                            const dailyCourierCountsDataForDashboard = {};
                            if (data.daily_courier_counts && data.daily_courier_counts.length > 0) {
                                data.daily_courier_counts.forEach(courier => {
                                    dailyCourierCountsDataForDashboard[courier.name] = courier.count;
                                });
                            }
                            // Call displayCourierDashboard which handles empty/populated cases
                            if (typeof displayCourierDashboard === "function") {
                                displayCourierDashboard(dailyCourierCountsDataForDashboard);
                            } else {
                                // Fallback if displayCourierDashboard is somehow not defined
                                console.error("displayCourierDashboard function is not defined! Using fallback.");
                                courierCountsList.innerHTML = ''; // Clear
                                if (Object.keys(dailyCourierCountsDataForDashboard).length > 0) {
                                    for (const name in dailyCourierCountsDataForDashboard) {
                                        const li = document.createElement('li');
                                        li.textContent = `${name}: ${dailyCourierCountsDataForDashboard[name]}`;
                                        courierCountsList.appendChild(li);
                                    }
                                } else {
                                    courierCountsList.innerHTML = '<li>No courier data to display (fallback).</li>';
                                }
                            }
                            // Ensure the display section for courier counts is visible
                            if (dailyCourierCountsDisplay) dailyCourierCountsDisplay.style.display = 'block';


                        } else {
                            if (packFormsetContainer) packFormsetContainer.innerHTML = `<p class="text-red-500 text-center">${data.message || 'Failed to load items.'}</p>`;
                            if (typeof Swal !== 'undefined') Swal.fire('Info', data.message || 'Could not load items.', 'info'); else alert(data.message || 'Could not load items.');
                            if (packModalToggle && data.message) packModalToggle.checked = true;
                        }
                    })
                    .catch(error => {
                        if (packFormsetContainer) packFormsetContainer.innerHTML = `<p class="text-red-500 text-center">Error: ${error.message}</p>`;
                        if (packModalToggle) packModalToggle.checked = true; // Show modal to display error
                    });
            });
            button.dataset.listenerAttached = 'true';
        });
    }

    function initializeEditOrderButtons() {
        const currentContainer = document.getElementById('operation-tab-content');
        if (!currentContainer) return;
        currentContainer.querySelectorAll('.edit-order-btn').forEach(button => {
            if (button.dataset.editListenerAttached === 'true') return;
            button.addEventListener('click', function(event) {
                event.preventDefault();
                const orderPk = this.dataset.orderPk;
                const editModalToggle = document.getElementById('edit-order-modal-toggle');
                const editFormsetContainer = document.getElementById('edit-order-items-formset-container');
                const editModalTitle = document.getElementById('edit-modal-title');
                const editModalCustomer = document.getElementById('edit-modal-customer-info');
                const hiddenOrderPkInput = document.getElementById('order_pk_for_editing_modal_hidden_id_js');
                const removedItemsDisplay = document.getElementById('removed-items-display');
                const editOrderForm = document.getElementById('edit-order-form');

                if (!orderPk || !editModalToggle || !editFormsetContainer || !editModalTitle || !editModalCustomer || !editOrderForm || !hiddenOrderPkInput || !removedItemsDisplay) return;
                editFormsetContainer.innerHTML = '<p class="text-center py-4 text-gray-400">Fetching items...</p>';
                removedItemsDisplay.innerHTML = '<p>Loading log...</p>';
                fetch(`/operation/order/${orderPk}/get-items-for-editing/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            editModalTitle.textContent = `Edit Items for Order: ${data.erp_order_id || orderPk}`;
                            editModalCustomer.textContent = `Customer: ${data.customer_name || 'N/A'}`;
                            editFormsetContainer.innerHTML = data.formset_html;
                            editOrderForm.action = `/operation/order/${orderPk}/process-item-removal/`;
                            hiddenOrderPkInput.value = orderPk;
                            if (data.removed_items_log && data.removed_items_log.length > 0) {
                                let logHtml = '<ul>';
                                data.removed_items_log.forEach(logEntry => {
                                    logHtml += `<li class="mb-1 p-1 border-b border-gray-200">SKU ${logEntry.product_sku || 'N/A'}: ${logEntry.removed_qty} unit(s) removed on ${new Date(logEntry.removed_at).toLocaleString()}</li>`;
                                });
                                logHtml += '</ul>';
                                removedItemsDisplay.innerHTML = logHtml;
                            } else {
                                removedItemsDisplay.innerHTML = '<p>No items previously removed.</p>';
                            }
                            editModalToggle.checked = true;
                        } else {
                            if (typeof Swal !== 'undefined') Swal.fire('Error', data.message || 'Could not load items.', 'error'); else alert(data.message || 'Could not load items.');
                            editFormsetContainer.innerHTML = `<p class="text-red-500 p-2">${data.message || 'Failed to load.'}</p>`;
                        }
                    })
                    .catch(error => {
                        if (typeof Swal !== 'undefined') Swal.fire('Error', 'Could not load data. Check console.', 'error');
                        editFormsetContainer.innerHTML = '<p class="text-red-500 p-2">Error loading data.</p>';
                    });
            });
            button.dataset.editListenerAttached = 'true';
        });
    }

    function updateParcelFilterControlsUI() {
        const currentTabContent = document.getElementById('operation-tab-content');
        if (!currentTabContent) return;
        const filterPanel = currentTabContent.querySelector('.operations-filter-panel');
        if (!filterPanel || !currentTabContent.querySelector('#parcels-list-tbody')) {
             console.warn("[updateParcelFilterControlsUI] Parcel filter panel or tbody not found in current tab content.");
            return;
        }

        const activeWarehouse = currentParcelFilters.parcel_warehouse || "";
        filterPanel.querySelectorAll('.parcel-warehouse-filter-btn').forEach(btn => {
            if (btn.dataset.value === activeWarehouse) {
                btn.classList.add('btn-neutral', 'text-white'); btn.classList.remove('btn-outline');
            } else {
                btn.classList.remove('btn-neutral', 'text-white'); btn.classList.add('btn-outline');
            }
        });

        const activeCourier = currentParcelFilters.parcel_courier || "";
        filterPanel.querySelectorAll('.parcel-courier-filter-btn').forEach(btn => {
            if (btn.dataset.value === activeCourier) {
                btn.classList.add('btn-neutral', 'text-white'); btn.classList.remove('btn-outline');
            } else {
                btn.classList.remove('btn-neutral', 'text-white'); btn.classList.add('btn-outline');
            }
        });

        const searchInput = filterPanel.querySelector('.parcel-dynamic-search-input');
        if (searchInput) {
             if (searchInput.value !== (currentParcelFilters.parcel_q || "")) {
                searchInput.value = currentParcelFilters.parcel_q || "";
            }
        }
        const parcelCountSpan = filterPanel.querySelector('.parcel-count');
        if (parcelCountSpan && currentParcelFilters.total_parcels_count !== undefined) {
             parcelCountSpan.textContent = `(${currentParcelFilters.total_parcels_count} parcels)`;
        }
         console.log("[updateParcelFilterControlsUI] Parcel filter UI updated.");
    }

    const debouncedParcelSearch = debounce(function(caller) {
        applyParcelFilters(true, caller);
    }, 400);

    function bindParcelFilterControls() {
        const currentTabContent = document.getElementById('operation-tab-content');
        if (!currentTabContent) {
            console.warn("[bindParcelFilterControls] #operation-tab-content not found.");
            return;
        }
        const filterPanel = currentTabContent.querySelector('.operations-filter-panel');

        if (!filterPanel || !currentTabContent.querySelector('#parcels-list-tbody')) {
             console.warn("[bindParcelFilterControls] Parcel filter panel or tbody not found in current content. Listeners NOT attached.");
             return;
        }
        console.log("[bindParcelFilterControls] Found parcel filter panel:", filterPanel);

        filterPanel.querySelectorAll('.parcel-warehouse-filter-btn').forEach(button => {
            if (button.dataset.parcelWhListenerAttached === 'true') return;
            button.addEventListener('click', function() {
                console.log("[ParcelFilterClick] Warehouse button clicked. Value:", this.dataset.value);
                currentParcelFilters.parcel_warehouse = this.dataset.value;
                applyParcelFilters(true, "Parcel WH Button Click");
            });
            button.dataset.parcelWhListenerAttached = 'true';
        });

        filterPanel.querySelectorAll('.parcel-courier-filter-btn').forEach(button => {
            if (button.dataset.parcelCourierListenerAttached === 'true') return;
            button.addEventListener('click', function() {
                console.log("[ParcelFilterClick] Courier button clicked. Value:", this.dataset.value);
                currentParcelFilters.parcel_courier = this.dataset.value;
                applyParcelFilters(true, "Parcel Courier Click");
            });
            button.dataset.parcelCourierListenerAttached = 'true';
        });

        const resetButton = filterPanel.querySelector('.parcel-reset-filters-btn');
        if (resetButton && resetButton.dataset.parcelResetListenerAttached !== 'true') {
            resetButton.addEventListener('click', function() {
                console.log("[ParcelFilterClick] Reset button clicked.");
                currentParcelFilters = { page: '1', parcel_warehouse: '', parcel_courier: '', parcel_q: '' };
                clearTabFiltersFromSession(DEFAULT_PARCELS_TAB);
                const searchInputInPanel = filterPanel.querySelector('input.parcel-dynamic-search-input');
                if (searchInputInPanel) searchInputInPanel.value = "";
                applyParcelFilters(true, "Parcel Reset Click");
            });
            resetButton.dataset.parcelResetListenerAttached = 'true';
        }

        const searchInput = filterPanel.querySelector('input.parcel-dynamic-search-input');
        if (searchInput && !searchInput.dataset.parcelSearchListener) {
            searchInput.addEventListener('input', function() {
                console.log("[ParcelSearchInput] Value:", this.value);
                currentParcelFilters.parcel_q = this.value.trim();
                debouncedParcelSearch("Parcel Search Input");
            });
            searchInput.dataset.parcelSearchListener = 'true';
            console.log("[bindParcelFilterControls] Parcel search input listener attached.");
        }
        console.log("[bindParcelFilterControls] Parcel filter controls binding attempt complete.");
    }

    function applyParcelFilters(resetPage = true, caller = "unknown") {
        if (isFetchingParcels) {
            console.log(`[applyParcelFilters BY ${caller}] Already fetching parcels, request ignored.`);
            return;
        }
        isFetchingParcels = true;
        console.log(`[applyParcelFilters BY ${caller}] resetPage: ${resetPage}. Setting isFetchingParcels = true.`);

        if (resetPage) {
            currentParcelFilters.page = '1';
        }
        console.log(`[applyParcelFilters] Applying with filters:`, JSON.parse(JSON.stringify(currentParcelFilters)));

        const params = new URLSearchParams();
        params.set('tab', DEFAULT_PARCELS_TAB);
        params.set('page', currentParcelFilters.page);

        if (currentParcelFilters.parcel_warehouse) {
            params.set('parcel_warehouse', currentParcelFilters.parcel_warehouse);
        }
        if (currentParcelFilters.parcel_courier) {
            params.set('parcel_courier', currentParcelFilters.parcel_courier);
        }
        if (currentParcelFilters.parcel_q) {
            params.set('parcel_q', currentParcelFilters.parcel_q);
        }

        const newUrl = `${currentBaseUrl}?${params.toString()}`;
        history.pushState({path: newUrl, tab: DEFAULT_PARCELS_TAB}, '', newUrl);
        saveTabFiltersToSession(DEFAULT_PARCELS_TAB, currentParcelFilters);

        const tabContentContainer = document.getElementById('operation-tab-content');

        if (tabContentContainer) {
            tabContentContainer.innerHTML = '<div class="text-center py-10"><span class="loading loading-dots loading-lg"></span> [JS Fetching Parcels...]</div>';
        } else {
            console.error("CRITICAL: #operation-tab-content not found for parcel tab update.");
            isFetchingParcels = false;
            return;
        }

        fetch(newUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(`Network error: ${response.status}. ${text.substring(0,100)}`); });
                }
                const totalCountHeader = response.headers.get('X-Total-Parcels-Count');
                if (totalCountHeader !== null) {
                    currentParcelFilters.total_parcels_count = totalCountHeader;
                }
                return response.text();
            })
            .then(html => {
                if(tabContentContainer) {
                    tabContentContainer.innerHTML = html;
                    loadInitialParcelFilters(new URLSearchParams(newUrl.split('?')[1]));
                    bindParcelFilterControls();
                    bindParcelPaginationButtons();
                }
                updateParcelFilterControlsUI();
                console.log("[applyParcelFilters] Parcel tab content refreshed.");
            })
            .catch(error => {
                console.error('[applyParcelFilters] Fetch CATCH block. Error:', error.message, error);
                if (tabContentContainer) {
                    tabContentContainer.innerHTML = `<p class="text-center py-10 text-red-500">Error loading parcels: ${error.message}</p>`;
                }
            })
            .finally(() => {
                isFetchingParcels = false;
                console.log(`[applyParcelFilters FINALLY BY ${caller}] Setting isFetchingParcels = false.`);
            });
    }

    function bindParcelPaginationButtons() {
        const currentTabContent = document.getElementById('operation-tab-content');
        if (!currentTabContent) return;
        const paginationControls = currentTabContent.querySelector('.parcel-pagination-controls');
        if (!paginationControls) {
            return;
        }

        paginationControls.querySelectorAll('.parcel-page-btn').forEach(button => {
            if (button.dataset.pageListenerAttached === 'true') return;
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const page = this.dataset.page;
                if (page) {
                    console.log(`[ParcelPagination] Page button clicked: ${page}`);
                    currentParcelFilters.page = page;
                    applyParcelFilters(false, `Parcel Page ${page} Click`);
                }
            });
            button.dataset.pageListenerAttached = 'true';
        });
        console.log("[bindParcelPaginationButtons] Parcel pagination buttons bound.");
    }


    function loadInitialParcelFilters(urlParams) {
        currentParcelFilters.parcel_warehouse = urlParams.get('parcel_warehouse') || "";
        currentParcelFilters.parcel_courier = urlParams.get('parcel_courier') || "";
        currentParcelFilters.parcel_q = urlParams.get('parcel_q') || "";
        currentParcelFilters.page = urlParams.get('page') || '1';
        console.log("[loadInitialParcelFilters] Initialized currentParcelFilters:", JSON.parse(JSON.stringify(currentParcelFilters)));
        updateParcelFilterControlsUI();
    }

    function highlightActiveTab(activeTabName) {
        mainPageTabs.forEach(tabLink => {
            const tabLinkName = tabLink.dataset.tab;
            const activeClasses = ['tab-active', 'bg-blue-500', 'text-white'];
            const inactiveClasses = ['bg-gray-200', 'text-gray-700', 'hover:bg-gray-300'];

            if (tabLinkName === activeTabName) {
                tabLink.classList.remove(...inactiveClasses);
                tabLink.classList.add(...activeClasses);
            } else {
                tabLink.classList.remove(...activeClasses);
                tabLink.classList.add(...inactiveClasses);
            }
        });
         console.log(`[highlightActiveTab] Active tab set to: ${activeTabName}`);
    }

    function loadTabContent(tabUrl, pushState = true) {
        if (!tabContainer) {
            console.error("[loadTabContent] tabContainer is not defined!");
            return;
        }
        tabContainer.innerHTML = '<div class="text-center py-10"><span class="loading loading-dots loading-lg"></span></div>';

        const fetchedUrlParams = new URLSearchParams(tabUrl.split('?')[1]);
        const targetTabName = fetchedUrlParams.get('tab') || DEFAULT_ORDER_MGMT_TAB;

        console.log(`[loadTabContent] Attempting to load tab content for: '${targetTabName}', URL: '${tabUrl}'`);

        let isCurrentlyFetching = false;
        if (targetTabName === DEFAULT_CUSTOMER_ORDERS_TAB) {
            isCurrentlyFetching = isFetchingCustomerOrders;
        } else if (targetTabName === DEFAULT_PARCELS_TAB) {
            isCurrentlyFetching = isFetchingParcels;
        }

        if (isCurrentlyFetching) {
            console.log(`[loadTabContent] Already fetching for tab '${targetTabName}', request to load new content ignored.`);
            if (tabContainer.innerHTML.indexOf('loading-dots') === -1) {
                 tabContainer.innerHTML = '<div class="text-center py-10"><span class="loading loading-dots loading-lg"></span></div>';
            }
            return;
        }

        if (targetTabName === DEFAULT_CUSTOMER_ORDERS_TAB) isFetchingCustomerOrders = true;
        else if (targetTabName === DEFAULT_PARCELS_TAB) isFetchingParcels = true;


        fetch(tabUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error ${response.status} for ${tabUrl}`);
                console.log(`[loadTabContent] Fetched response for '${targetTabName}', status: ${response.status}`);
                return response.text();
            })
            .then(html => {
                console.log(`[loadTabContent] Successfully fetched HTML for tab: '${targetTabName}'.`);
                tabContainer.innerHTML = html;
                if (pushState) {
                    history.pushState({path: tabUrl, tab: targetTabName}, '', tabUrl);
                }
                highlightActiveTab(targetTabName);
                console.log(`[loadTabContent] Initializing JS (sync) for tab: '${targetTabName}'`);

                if (targetTabName === DEFAULT_CUSTOMER_ORDERS_TAB) {
                    console.log("[loadTabContent] -> Initializing Customer Orders tab JS.");
                    loadInitialCustomerOrderFilters(fetchedUrlParams);
                    bindCustomerOrderFilterControls();
                    initializePackOrderButtons();
                    initializeEditOrderButtons();
                    initLoadMoreCustomerOrders();
                } else if (targetTabName === DEFAULT_PARCELS_TAB) {
                    console.log("[loadTabContent] -> Initializing Parcels Detail tab JS.");
                    loadInitialParcelFilters(fetchedUrlParams);
                    bindParcelFilterControls();
                    bindParcelPaginationButtons();
                    console.log("[loadTabContent] -> Parcel tab specific JS initializers CALLED.");
                } else {
                    console.warn(`[loadTabContent] Tab '${targetTabName}' did not match any known tab for JS initialization.`);
                }
            })
            .catch(error => {
                console.error(`[loadTabContent] Failed to load tab content for '${targetTabName}':`, error);
                if (tabContainer) tabContainer.innerHTML = `<p class="text-red-500 text-center">Error loading content for ${targetTabName}. Please try again.</p>`;
            })
            .finally(() => {
                if (targetTabName === DEFAULT_CUSTOMER_ORDERS_TAB) isFetchingCustomerOrders = false;
                else if (targetTabName === DEFAULT_PARCELS_TAB) isFetchingParcels = false;
                console.log(`[loadTabContent FINALLY] Fetching flag for '${targetTabName}' reset.`);
            });
    }

    mainPageTabs.forEach(tab => {
        if (tab.dataset.tabListenerAttached === 'true') return;
        tab.addEventListener("click", function (e) {
            e.preventDefault();
            const targetTabName = this.dataset.tab;
            const currentActiveTab = getCurrentTabNameFromUrl();

            console.log(`[Tab Click] Target: ${targetTabName}, Current: ${currentActiveTab}`);

            if (currentActiveTab && currentActiveTab !== targetTabName) {
                let stateToSaveOnClick = {};
                if (currentActiveTab === DEFAULT_CUSTOMER_ORDERS_TAB) {
                    stateToSaveOnClick = currentCustomerOrderFilters;
                } else if (currentActiveTab === DEFAULT_PARCELS_TAB) {
                    stateToSaveOnClick = currentParcelFilters;
                }
                saveTabFiltersToSession(currentActiveTab, stateToSaveOnClick);
                console.log(`[Tab Switch] Saved filters for outgoing tab '${currentActiveTab}':`, JSON.parse(JSON.stringify(stateToSaveOnClick)));
            }

            const paramsFromSessionForTargetTab = loadTabFiltersFromSession(targetTabName);
            paramsFromSessionForTargetTab.set("tab", targetTabName);

            const finalUrlForTargetTab = `${currentBaseUrl}?${paramsFromSessionForTargetTab.toString()}`;
            console.log(`[Tab Switch] Navigating to tab '${targetTabName}' with URL (from session): ${finalUrlForTargetTab}`);

            loadTabContent(finalUrlForTargetTab, true);
        });
        tab.dataset.tabListenerAttached = 'true';
    });

    window.onpopstate = function(event) {
        let poppedUrl;
        if (event.state && event.state.path) {
            poppedUrl = event.state.path;
        } else {
            const params = new URLSearchParams(window.location.search);
            const currentTabFromUrl = params.get('tab') || DEFAULT_ORDER_MGMT_TAB;
            params.set('tab', currentTabFromUrl);
            poppedUrl = `${currentBaseUrl}?${params.toString()}`;
        }
        console.log("[onpopstate] Popped URL:", poppedUrl);
        loadTabContent(poppedUrl, false);
    };

    const initialUrlParamsOnLoad = new URLSearchParams(window.location.search);
    let initialTabNameOnLoad = initialUrlParamsOnLoad.get('tab') || DEFAULT_ORDER_MGMT_TAB;

    if (!initialUrlParamsOnLoad.has('tab')) {
        initialUrlParamsOnLoad.set('tab', initialTabNameOnLoad);
    }

    const paramsFromSessionForInitialTab = loadTabFiltersFromSession(initialTabNameOnLoad);
    const finalParamsForInitialLoad = new URLSearchParams(initialUrlParamsOnLoad);

    paramsFromSessionForInitialTab.forEach((value, key) => {
        if (!finalParamsForInitialLoad.has(key)) {
            finalParamsForInitialLoad.set(key, value);
        }
    });
    finalParamsForInitialLoad.set('tab', initialTabNameOnLoad);

    const finalInitialUrl = `${currentBaseUrl}?${finalParamsForInitialLoad.toString()}`;
    console.log(`[Initial Load] Final URL for initial load: ${finalInitialUrl}`);
    history.replaceState({path: finalInitialUrl, tab: initialTabNameOnLoad}, '', finalInitialUrl);
    highlightActiveTab(initialTabNameOnLoad);

    if (tabContainer) {
        tabContainer.innerHTML = '<div class="text-center py-10"><span class="loading loading-dots loading-lg"></span></div>';
    }

    fetch(finalInitialUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok for initial tab content.');
            const totalOrdersCountHeader = response.headers.get('X-Total-Orders-Count');
            const totalParcelsCountHeader = response.headers.get('X-Total-Parcels-Count');
            if (initialTabNameOnLoad === DEFAULT_CUSTOMER_ORDERS_TAB && totalOrdersCountHeader !== null) {
                currentCustomerOrderFilters.total_orders_count = totalOrdersCountHeader;
            } else if (initialTabNameOnLoad === DEFAULT_PARCELS_TAB && totalParcelsCountHeader !== null) {
                currentParcelFilters.total_parcels_count = totalParcelsCountHeader;
            }
            return response.text();
        })
        .then(html => {
            if (tabContainer) tabContainer.innerHTML = html;
            requestAnimationFrame(() => {
                const initialUrlParams = new URLSearchParams(finalInitialUrl.split('?')[1]);
                const initialActiveTabName = initialUrlParams.get('tab') || DEFAULT_ORDER_MGMT_TAB;

                console.log(`[DOMContentLoaded - rAF] Initializing JS. Determined initialActiveTabName: '${initialActiveTabName}'`);

                if (initialActiveTabName === DEFAULT_CUSTOMER_ORDERS_TAB) {
                    console.log("[DOMContentLoaded - rAF] Matched CUSTOMER_ORDERS_TAB for initial load. Initializing its JS.");
                    loadInitialCustomerOrderFilters(initialUrlParams);
                    bindCustomerOrderFilterControls();
                    initializePackOrderButtons();
                    initializeEditOrderButtons();
                    initLoadMoreCustomerOrders();
                } else if (initialActiveTabName === DEFAULT_PARCELS_TAB) {
                    console.log("[DOMContentLoaded - rAF] Matched PARCELS_TAB for initial load. Initializing its JS.");
                    loadInitialParcelFilters(initialUrlParams);
                    bindParcelFilterControls();
                    bindParcelPaginationButtons();
                    console.log("[DOMContentLoaded - rAF] Parcel tab specific JS initializers called for initial load.");
                } else {
                     console.warn(`[DOMContentLoaded - rAF] Tab '${initialActiveTabName}' did not match any known tab for initial JS initialization.`);
                }
            });

        })
        .catch(error => {
            console.error("Error loading initial tab content:", error);
            if (tabContainer) tabContainer.innerHTML = `<p class="text-red-500 text-center">Error loading initial content: ${error.message}.</p>`;
        });

    const importModalToggle = document.getElementById('import-orders-modal-toggle');
    const importFileInput = document.querySelector('.modal input[type="file"][name="excel_file"]');
    if (importModalToggle && importFileInput) {
        const observer = new MutationObserver(function(mutationsList, observer) {
            for (const mutation of mutationsList) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'checked') {
                    if (!importModalToggle.checked) { importFileInput.value = ''; }
                }
            }
        });
        observer.observe(importModalToggle, { attributes: true });
    }

    const packModalToggle = document.getElementById('pack-order-modal-toggle');
    const packForm = document.getElementById('pack-order-form');
    // const packFormsetContainer = document.getElementById('pack-order-items-formset-container'); // Already declared above
    // const packModalTitle = document.getElementById('pack-modal-title'); // Already declared above
    // const packModalCustomer = document.getElementById('pack-modal-customer'); // Already declared above
    // const orderPkHiddenInput = document.getElementById('order_pk_for_packing_modal_hidden_id'); // Already declared above

    const allPackagingButtonsContainer = document.querySelector('.modal-box #pack-order-form');
    if (allPackagingButtonsContainer) {
        allPackagingButtonsContainer.addEventListener('click', function(e) {
            const clickedButton = e.target.closest('.packaging-btn');
            if (clickedButton) {
                e.preventDefault();
                const selectedPackagingValue = clickedButton.dataset.packaging;
                const hiddenPackagingInput = document.getElementById('id_parcel-packaging_type');

                if (hiddenPackagingInput) {
                    hiddenPackagingInput.value = selectedPackagingValue;
                } else {
                    console.error("[PackagingClick] Hidden input #id_parcel-packaging_type not found!");
                    return;
                }
                document.querySelectorAll('.packaging-btn').forEach(btn => {
                    if (btn === clickedButton && selectedPackagingValue !== "") {
                        btn.classList.add('btn-active', 'btn-neutral');
                        btn.classList.remove('btn-outline');
                    } else {
                        btn.classList.remove('btn-active', 'btn-neutral');
                        btn.classList.add('btn-outline');
                    }
                });
            }
        });
    } else {
        console.error("Common parent for packaging buttons not found in modal.");
    }

    const courierButtonsContainer = document.getElementById('courier-selection-buttons');
    if (courierButtonsContainer) {
        const hiddenCourierInput = document.getElementById('id_parcel-courier_name');
        courierButtonsContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('courier-btn')) {
                e.preventDefault();
                const selectedCourier = e.target.dataset.courier;

                if (hiddenCourierInput) {
                    hiddenCourierInput.value = selectedCourier;
                }

                courierButtonsContainer.querySelectorAll('.courier-btn').forEach(btn => {
                    if (btn === e.target && selectedCourier !== "") {
                        btn.classList.add('btn-active', 'btn-neutral');
                        btn.classList.remove('btn-outline');
                    } else {
                        btn.classList.remove('btn-active', 'btn-neutral');
                        btn.classList.add('btn-outline');
                    }
                });
                if (selectedCourier === "") {
                     if (hiddenCourierInput) hiddenCourierInput.value = "";
                }
            }
        });
    }

    if (packForm) {
        packForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(packForm);
            const saveBtn = packForm.querySelector('button[type="submit"]');
            const originalBtnText = saveBtn.innerHTML;
            saveBtn.disabled = true; saveBtn.innerHTML = '<span class="loading loading-spinner text-sm"></span> Processing...';

            fetch(packForm.action, {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken'), 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if(typeof Swal !== 'undefined') Swal.fire({toast: true, icon: 'success', title: data.message || 'Parcel created!', position: 'top-end', showConfirmButton: false, timer: 2500});
                    else alert(data.message || 'Parcel created!');
                    if(packModalToggle) packModalToggle.checked = false;
                    packForm.reset();
                    const targetTabUrl = data.redirect_url || `${window.location.pathname}?tab={{ DEFAULT_CUSTOMER_ORDERS_TAB|escapejs }}`;
                    if(typeof loadTabContent === "function") loadTabContent(targetTabUrl, true);
                    else window.location.href = targetTabUrl;
                } else {
                    let errorMsg = data.message || 'Could not create parcel.';
                    if (data.errors && typeof data.errors === 'object') {
                        errorMsg += " Details: " + Object.entries(data.errors).map(([field, err]) => `${field.replace(/^parcel-/, '').replace(/_/g, " ").replace(/\b\w/g, l => l.toUpperCase())}: ${err}`).join('; ');
                    }
                    if(typeof Swal !== 'undefined') Swal.fire({ icon: 'error', title: 'Packing Failed', text: errorMsg, confirmButtonText: 'OK' });
                    else alert(errorMsg);
                }
            })
            .catch(error => {
                console.error('Error submitting pack form:', error);
                if(typeof Swal !== 'undefined') Swal.fire({ icon: 'error', title: 'Network Error', text: 'Could not submit form. Please try again.'});
                else alert('Network Error: Could not submit form. Please try again.');
            })
            .finally(() => { if(saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = originalBtnText; } });
        });
    }

    const editOrderForm = document.getElementById('edit-order-form');
    if (editOrderForm) {
        editOrderForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(editOrderForm);
            const saveBtn = editOrderForm.querySelector('button[type="submit"]');
            const originalBtnText = saveBtn.innerHTML;
            saveBtn.disabled = true; saveBtn.innerHTML = '<span class="loading loading-spinner text-sm"></span> Processing...';

            fetch(editOrderForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json() )
            .then(data => {
                if (data.success) {
                    if(typeof Swal !== 'undefined') Swal.fire({toast: true, icon: 'success', title: data.message || 'Order items updated!', position: 'top-end', showConfirmButton: false, timer: 2500});
                    else alert(data.message || 'Order items updated!');
                    const editModalToggle = document.getElementById('edit-order-modal-toggle');
                    if(editModalToggle) editModalToggle.checked = false;
                    editOrderForm.reset();
                    const currentUrlParams = new URLSearchParams(window.location.search);
                    const activeTab = currentUrlParams.get('tab') || DEFAULT_CUSTOMER_ORDERS_TAB;
                    if (activeTab === DEFAULT_CUSTOMER_ORDERS_TAB && typeof applyCustomerOrderFilters === "function") {
                        applyCustomerOrderFilters(false, "EditForm Success");
                    } else if (activeTab === DEFAULT_CUSTOMER_ORDERS_TAB) {
                        loadTabContent(`${currentBaseUrl}?tab=${DEFAULT_CUSTOMER_ORDERS_TAB}`, true);
                    } else {
                        window.location.reload();
                    }
                }  else {
                    let errorMsg = data.message || 'Could not update order items.';
                    if (data.errors && typeof data.errors === 'object') {
                        errorMsg += " Details: " + Object.entries(data.errors).map(([field, errs]) => `${field}: ${errs.join(', ')}`).join('; ');
                    } else if (data.formset_errors) {
                         errorMsg += " Formset Errors: " + JSON.stringify(data.formset_errors);
                    }
                    if(typeof Swal !== 'undefined') Swal.fire({ icon: 'error', title: 'Update Failed', text: errorMsg, confirmButtonText: 'OK' });
                    else alert(errorMsg);
                }
            })
            .catch(error => {
                console.error('[JS EditForm] Fetch Error:', error);
                if(typeof Swal !== 'undefined') Swal.fire({ icon: 'error', title: 'Network Error', text: 'Could not submit form. Check console. (' + error.message + ')'});
                else alert('Network Error: Could not submit form. Check console. (' + error.message + ')');
            })
            .finally(() => {
                if(saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalBtnText;
                }
            });
        });
    }
});
</script>
{% endblock %}
