{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load humanize %}

{% block page_title %}{{ page_title|default:"Operations Management" }}{% endblock %}

{% block content %}
    {# Tabs Navigation #}
    <div class="shrink-0 mb-2 sticky top-[4rem] h-fit bg-base-100 rounded shadow z-10">
        <div class="tabs max-w-7xl mx-auto">
        <a class="tab tab-lifted text-lg transition
           {% if active_tab == DEFAULT_CUSTOMER_ORDERS_TAB %}tab-active bg-blue-500 text-white{% else %}bg-gray-200 hover:bg-gray-300 text-gray-700{% endif %}"
           href="?tab={{ DEFAULT_CUSTOMER_ORDERS_TAB }}"
           data-tab-url="?tab={{ DEFAULT_CUSTOMER_ORDERS_TAB }}"
           data-tab="{{ DEFAULT_CUSTOMER_ORDERS_TAB }}">
            Customer Orders
        </a>
        <a class="tab tab-lifted text-lg transition
           {% if active_tab == DEFAULT_PARCELS_TAB %}tab-active bg-blue-500 text-white{% else %}bg-gray-200 hover:bg-gray-300 text-gray-700{% endif %}"
           href="?tab={{ DEFAULT_PARCELS_TAB }}"
           data-tab-url="?tab={{ DEFAULT_PARCELS_TAB }}"
           data-tab="{{ DEFAULT_PARCELS_TAB }}">
            Parcel Details
        </a>
        </div>
    </div>

    {# Dynamic Content Area for Tabs #}
    <div id="operation-tab-content">
        {% if active_tab == DEFAULT_CUSTOMER_ORDERS_TAB %}
            {% include 'operation/partials/customer_orders_table.html' %}
        {% elif active_tab == DEFAULT_PARCELS_TAB %}
            {% include 'operation/partials/parcels_table.html' %}
        {% else %}
            <p>Select a tab to view content.</p>
        {% endif %}
    </div>

{# MODAL HTML for Excel Import #}
<input type="checkbox" id="import-orders-modal-toggle" class="modal-toggle" />
<div class="modal" role="dialog">
  <div class="modal-box max-w-lg">
    <form method="post" enctype="multipart/form-data" action="{% url 'operation:import_orders_from_excel' %}">
        {% csrf_token %}
        <label for="import-orders-modal-toggle" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</label>
        <h3 class="font-bold text-xl mb-4">Import Orders via Excel</h3>
        <div class="form-control w-full mb-4">
            {{ import_form.excel_file.label_tag }}
            {{ import_form.excel_file }}
            {% if import_form.excel_file.help_text %}<label class="label"><span class="label-text-alt">{{ import_form.excel_file.help_text }}</span></label>{% endif %}
            {% for error in import_form.excel_file.errors %}<label class="label"><span class="label-text-alt text-error">{{ error }}</span></label>{% endfor %}
        </div>
        {% if import_form.non_field_errors %}
            <div class="alert alert-error shadow-sm mb-4">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span>{% for error in import_form.non_field_errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}</span>
                </div>
            </div>
        {% endif %}
        <div class="modal-action mt-6">
            <label for="import-orders-modal-toggle" class="btn btn-ghost">Cancel</label>
            <button type="submit" class="btn btn-primary">Upload and Process</button>
        </div>
    </form>
    <div class="divider mt-6 mb-2">Instructions</div>
    <div class="prose prose-sm max-w-none text-xs">
        <p>Ensure your Excel file (.xlsx or .xls) follows this format:</p>
        <ul><li>First sheet, first row must be headers.</li><li>Each row is one order item. Repeat order details for multiple items in one order.</li></ul>
        <p><strong>Expected Columns:</strong> `Order ID`, `Order Date` (YYYY-MM-DD or Month D,YYYY), `Address Name` (as Customer), `Product Name` (as SKU or Name), `Product Quantity`, `Warehouse Name`. Other columns like `Company`, `Address`, `isCold`, etc., will also be processed if present and mapped.</p>
    </div>
  </div>
  <label class="modal-backdrop" for="import-orders-modal-toggle">Close</label>
</div>

{# Pack Order Modal #}
<input type="checkbox" id="pack-order-modal-toggle" class="modal-toggle" />
<div class="modal" role="dialog" id="pack-order-modal-container">
    <div class="modal-box max-w-3xl" id="pack-order-modal-content"> {# Added id for event delegation #}
        <label for="pack-order-modal-toggle" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 modal-close-button">✕</label>
        <h3 class="font-bold text-xl mb-1" id="pack-modal-title">Pack Order</h3>
        <p class="text-sm text-gray-500 mb-4" id="pack-modal-customer"></p>

        <form id="pack-order-form" method="POST">
            {% csrf_token %}
            <input type="hidden" name="order_pk_for_packing" id="order_pk_for_packing_modal_hidden_id">
            <input type="hidden" name="order_is_cold_chain" id="order_is_cold_chain_hidden_id">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 mb-4">
                <div class="border p-3 rounded-md bg-gray-50">
                    <div id="daily-courier-counts-display" class="mb-3">
                        <h4 class="text-sm font-semibold text-gray-700 mb-1">Today's Couriers:</h4>
                        <ul class="flex flex-wrap gap-3" id="courier-counts-list"></ul>
                    </div>
                    <label class="label"><span class="label-text font-semibold">Select Courier</span></label>
                    <div class="flex flex-wrap gap-2" id="courier-selection-buttons">
                        {# Dynamically populated by JavaScript #}
                    </div>
                    <input type="hidden" name="parcel-courier_id" id="id_parcel-courier_id">
                </div>

                <div class="border p-3 rounded-md bg-gray-50 mt-4 md:mt-0">
                    <div class="mb-2">
                        <h4 class="text-sm font-semibold text-gray-700">Order Requirement:</h4>
                        <span id="order-cold-chain-status-display" class="font-bold">Loading...</span>
                    </div>
                    <label class="label"><span class="label-text font-semibold">Select Packaging</span></label>

                    <div id="packaging-options-container" class="flex flex-wrap gap-2 mt-1">
                        </div>

                    <input type="hidden" name="parcel-packaging_type" id="id_parcel-packaging_type">
                </div>
            </div>

            <div class="mt-3">
                <label class="label" for="id_parcel-notes"><span class="label-text font-semibold">Parcel Notes</span></label>
                <textarea name="parcel-notes" id="id_parcel-notes" class="textarea textarea-bordered textarea-sm w-full" rows="2"></textarea>
            </div>

            <h4 class="text-md font-semibold mb-2">Items to Pack:</h4>
            <div id="pack-order-items-formset-container" class="mb-4 max-h-60 overflow-y-auto">
                <p class="text-center py-4 text-gray-400">Loading items...</p>
            </div>
            <div class="modal-action mt-12">
                <label for="pack-order-modal-toggle" class="btn btn-ghost modal-close-button">Cancel</label>
                <button type="submit" class="btn btn-primary">Create Parcel & Pack Items</button>
            </div>
        </form>
    </div>
    <label class="modal-backdrop modal-close-button" for="pack-order-modal-toggle">Close</label>
</div>

{# Edit Order Modal #}
<input type="checkbox" id="edit-order-modal-toggle" class="modal-toggle" />
<div class="modal" role="dialog" id="edit-order-modal-container">
    <div class="modal-box max-w-3xl">
        <label for="edit-order-modal-toggle" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 modal-close-button">✕</label>
        <h3 class="font-bold text-xl mb-1" id="edit-modal-title">Edit Order Items</h3>
        <p class="text-sm text-gray-500 mb-4" id="edit-modal-customer-info">Customer: </p>
        <form id="edit-order-form" method="POST"> {% csrf_token %}
            <input type="hidden" name="order_pk_for_editing" id="order_pk_for_editing_modal_hidden_id_js">

            <h4 class="text-md font-semibold mb-2">Items with Balance to Pack:</h4>
            <div id="edit-order-items-formset-container" class="mb-4 max-h-60 overflow-y-auto">
                <p class="text-center py-4 text-gray-400">Loading items...</p>
            </div>

            <div id="removed-items-log-container" class="mt-4">
                <h4 class="text-md font-semibold mb-2">Previously Removed Items:</h4>
                <div id="removed-items-display" class="text-xs text-gray-600 bg-gray-50 p-2 rounded max-h-28 overflow-y-auto">
                    <p>No items previously removed for this order.</p>
                </div>
            </div>

            <div class="modal-action mt-6">
                <label for="edit-order-modal-toggle" class="btn btn-ghost modal-close-button">Cancel</label>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
    <label class="modal-backdrop modal-close-button-edit" for="edit-order-modal-toggle">Close</label>
</div>

{# --- NEW MODAL FOR VIEW/EDIT PARCEL DETAILS --- #}
<input type="checkbox" id="view-edit-parcel-modal-toggle" class="modal-toggle" />
<div class="modal" role="dialog" id="view-edit-parcel-modal-container">
    <div class="modal-box max-w-4xl"> {# Increased max-width for more content #}
        <label for="view-edit-parcel-modal-toggle" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 modal-close-button">✕</label>
        <h3 class="font-bold text-xl mb-4" id="view-edit-parcel-modal-title">View/Edit Parcel Details</h3>
        <div id="view-edit-parcel-modal-content-area">
            {# Static info and form will be loaded here by JS #}
            <p class="text-center py-8">Loading parcel details...</p>
        </div>
    </div>
    <label class="modal-backdrop modal-close-button" for="view-edit-parcel-modal-toggle">Close</label>
</div>
{# --- END NEW MODAL --- #}

{% endblock %}

{% block extra_js %}
<script>
    const CSRF_TOKEN_INPUT = document.querySelector('input[name="csrfmiddlewaretoken"]');
    const CSRF_TOKEN = CSRF_TOKEN_INPUT ? CSRF_TOKEN_INPUT.value : '';
    const DEFAULT_CUSTOMER_ORDERS_TAB = "{{ DEFAULT_CUSTOMER_ORDERS_TAB|escapejs }}";
    const DEFAULT_PARCELS_TAB = "{{ DEFAULT_PARCELS_TAB|escapejs }}";
    const currentBaseUrl = "{% url 'operation:order_list' %}";
    var courierCompaniesGlobal = [];
    try {
        var jsonData = '{{ all_courier_companies_json|escapejs }}';
        if (jsonData && jsonData !== 'null' && jsonData !== 'undefined' && jsonData !== "[]") { // Check if jsonData is not empty array string
            courierCompaniesGlobal = JSON.parse(jsonData);
        }
    } catch (e) {
        console.error("Error parsing courier companies JSON:", e);
    }
    // console.log("Initialized courierCompaniesGlobal:", courierCompaniesGlobal); // Optional: for debugging

    console.log(`[Global JS Init] DEFAULT_CUSTOMER_ORDERS_TAB: '${DEFAULT_CUSTOMER_ORDERS_TAB}'`);
    console.log(`[Global JS Init] DEFAULT_PARCELS_TAB: '${DEFAULT_PARCELS_TAB}'`);
    console.log(`[Global JS Init] currentBaseUrl: '${currentBaseUrl}'`);

    document.addEventListener('DOMContentLoaded', function() {
    const tabContainer = document.getElementById('operation-tab-content');
    const mainPageTabs = document.querySelectorAll('.tabs a.tab');
    const ORDER_MGMT_TAB_SPECIFIC_PARAMS = {
        [DEFAULT_CUSTOMER_ORDERS_TAB]: ['warehouse', 'status', 'q', 'page'],
        [DEFAULT_PARCELS_TAB]: ['parcel_warehouse', 'parcel_courier', 'parcel_q', 'page', 'fetch_parcel_list_only'] // Added fetch_parcel_list_only
    };
    const DEFAULT_ORDER_MGMT_TAB = DEFAULT_CUSTOMER_ORDERS_TAB;

    let currentCustomerOrderFilters = { page: '1' };
    let currentParcelFilters = { page: '1', parcel_warehouse: '', parcel_courier: '', parcel_q: '' };
    let isFetchingCustomerOrders = false;
    let isFetchingParcels = false;

    function debounce(func, delay) {
        let timeout;
        const debounced = function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
        debounced.cancel = () => { clearTimeout(timeout); };
        return debounced;
    }

    function getCsrfToken() {
        if (CSRF_TOKEN) return CSRF_TOKEN;
        const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
        if (csrfInput) {
            console.warn("getCsrfToken: Had to re-query DOM for CSRF token.");
            return csrfInput.value;
        }
        console.error("getCsrfToken: CSRF Token is null and input field not found in DOM!");
        return "";
    }

    function displayCourierDashboard(dailyCounts, availableCouriers) {
        const dashboardList = document.getElementById('courier-counts-list');
        const mainCourierInput = document.getElementById('id_parcel-courier_id');

        if (!dashboardList) {
            console.error("Courier dashboard list (ul#courier-counts-list) not found.");
            return;
        }
        if (!mainCourierInput) {
            console.error("Main courier input field (#id_parcel-courier_id) not found.");
        }

        // Clear any previous buttons or messages
        dashboardList.innerHTML = '';

        // Ensure inputs are valid to prevent errors
        const recommendations = dailyCounts || {};
        const allCouriers = Array.isArray(availableCouriers) ? availableCouriers : [];

        // Match the daily counts with the full courier details (including ID)
        const couriersWithDetails = Object.entries(recommendations)
            .map(([courierName, count]) => {
                // Find the full details for the courier from the provided list
                const companyDetails = allCouriers.find(c => c.name === courierName);

                // Only include couriers that were found and have an ID
                if (companyDetails && companyDetails.id) {
                    return { id: companyDetails.id, name: courierName, count: count };
                }
                // If a courier name from the counts isn't in the main list, ignore it.
                return null;
            })
            .filter(Boolean); // This removes any null entries from the list

        // Sort couriers alphabetically for a consistent display
        couriersWithDetails.sort((a, b) => a.name.localeCompare(b.name));

        // --- Display Logic ---
        if (couriersWithDetails.length === 0) {
            const noItemsMessage = document.createElement('li');
            noItemsMessage.className = 'text-xs text-gray-500 italic';
            noItemsMessage.textContent = 'No courier counts for today.'; // This message will now appear correctly
            dashboardList.appendChild(noItemsMessage);
        } else {
            couriersWithDetails.forEach(courierItem => {
                const listItem = document.createElement('li');
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'btn btn-lg btn-square bg-gray-200 gap-1 flex-col';
                button.innerHTML = `<span class="text-sm">${courierItem.name}</span><span class="text-md">${courierItem.count}</span>`;

                // --- Interactive Click Handling ---
                button.addEventListener('click', function() {
                    // Update the main form's hidden input with the selected courier ID
                    if (mainCourierInput) {
                        mainCourierInput.value = courierItem.id;
                    }

                    // Visually highlight the selected button for better UX
                    dashboardList.querySelectorAll('button').forEach(btn => {
                        btn.classList.remove('btn-primary', 'text-white');
                        btn.classList.add('bg-gray-200');
                    });

                    this.classList.add('btn-primary', 'text-white');
                    this.classList.remove('bg-gray-200');
                });

                listItem.appendChild(button);
                dashboardList.appendChild(listItem);
            });
        }
    }


    function getCurrentTabNameFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('tab') || DEFAULT_ORDER_MGMT_TAB;
    }

    function saveTabFiltersToSession(tabName, filterState) {
        const paramsForStorage = new URLSearchParams();
        const allowedParams = ORDER_MGMT_TAB_SPECIFIC_PARAMS[tabName] || [];
        const sourceObject = (filterState instanceof URLSearchParams) ? Object.fromEntries(filterState.entries()) : (typeof filterState === 'object' && filterState !== null ? filterState : {});
        allowedParams.forEach(key => {
            if (sourceObject.hasOwnProperty(key) && sourceObject[key]) {
                paramsForStorage.set(key, sourceObject[key]);
            }
        });
        const paramsString = paramsForStorage.toString();
        sessionStorage.setItem(`tabFilters_${tabName}`, paramsString);
    }

    function loadTabFiltersFromSession(tabName) {
        const storedParamsString = sessionStorage.getItem(`tabFilters_${tabName}`);
        const params = new URLSearchParams(storedParamsString || '');
        if ((ORDER_MGMT_TAB_SPECIFIC_PARAMS[tabName] || []).includes('page') && !params.has('page')) {
            params.set('page', '1');
        }
        return params;
    }

    function clearTabFiltersFromSession(tabName) {
         sessionStorage.removeItem(`tabFilters_${tabName}`);
    }
    function clearAllTabFiltersFromSession() {
        for (const tabName in ORDER_MGMT_TAB_SPECIFIC_PARAMS) {
            sessionStorage.removeItem(`tabFilters_${tabName}`);
        }
    }

    function updateCustomerOrderFiltersUI() {
        const currentTabContent = document.getElementById('operation-tab-content');
        if (!currentTabContent) return;
        const filterPanel = currentTabContent.querySelector('.operations-filter-panel');
        if (!filterPanel || !currentTabContent.querySelector('#customer-orders-list-tbody')) {
            return;
        }
        const activeWarehouse = currentCustomerOrderFilters.warehouse || "";
        filterPanel.querySelectorAll('.warehouse-filter-btn').forEach(btn => {
            btn.classList.toggle('btn-neutral', btn.dataset.value === activeWarehouse);
            btn.classList.toggle('text-white', btn.dataset.value === activeWarehouse);
            btn.classList.toggle('btn-outline', btn.dataset.value !== activeWarehouse);
        });
        const activeStatus = currentCustomerOrderFilters.status || "";
        filterPanel.querySelectorAll('.status-filter-btn').forEach(btn => {
            btn.classList.toggle('btn-neutral', btn.dataset.value === activeStatus);
            btn.classList.toggle('text-white', btn.dataset.value === activeStatus);
            btn.classList.toggle('btn-outline', btn.dataset.value !== activeStatus);
        });
        const searchInput = filterPanel.querySelector('.dynamic-search-input');
        if (searchInput && searchInput.value !== (currentCustomerOrderFilters.q || "")) {
            searchInput.value = currentCustomerOrderFilters.q || "";
        }
        const orderCountSpan = filterPanel.querySelector('.customer-order-count');
         if (orderCountSpan && currentCustomerOrderFilters.total_orders_count !== undefined) {
            orderCountSpan.textContent = `(${currentCustomerOrderFilters.total_orders_count} orders)`;
        }
    }

    function loadInitialCustomerOrderFilters(urlParams) {
        const sessionFilters = loadTabFiltersFromSession(DEFAULT_CUSTOMER_ORDERS_TAB);
        currentCustomerOrderFilters.warehouse = urlParams.get('warehouse') || sessionFilters.get('warehouse') || "";
        currentCustomerOrderFilters.status = urlParams.get('status') || sessionFilters.get('status') || "";
        currentCustomerOrderFilters.q = urlParams.get('q') || sessionFilters.get('q') || "";
        currentCustomerOrderFilters.page = urlParams.get('page') || sessionFilters.get('page') || '1';
        updateCustomerOrderFiltersUI();
    }

    function applyCustomerOrderFilters(resetPage = true, caller="unknown_co_caller") {
        if (isFetchingCustomerOrders) return;
        isFetchingCustomerOrders = true;
        if (resetPage) currentCustomerOrderFilters.page = '1';

        const paramsForHistory = new URLSearchParams();
        paramsForHistory.set('tab', DEFAULT_CUSTOMER_ORDERS_TAB);
        if (currentCustomerOrderFilters.warehouse) paramsForHistory.set('warehouse', currentCustomerOrderFilters.warehouse);
        if (currentCustomerOrderFilters.status) paramsForHistory.set('status', currentCustomerOrderFilters.status);
        if (currentCustomerOrderFilters.q) paramsForHistory.set('q', currentCustomerOrderFilters.q);
        if (currentCustomerOrderFilters.page && currentCustomerOrderFilters.page !== '1') {
            paramsForHistory.set('page', currentCustomerOrderFilters.page);
        }
        const historyUrl = `${currentBaseUrl}?${paramsForHistory.toString()}`;

        const paramsForFetch = new URLSearchParams(paramsForHistory);
        paramsForFetch.set('page', currentCustomerOrderFilters.page);
        paramsForFetch.set('fetch_dynamic_content_only', 'true');
        const fetchUrl = `${currentBaseUrl}?${paramsForFetch.toString()}`;

        const dynamicContentContainer = document.getElementById('customer-orders-dynamic-content');
        if (dynamicContentContainer) {
            dynamicContentContainer.innerHTML = '<div class="text-center py-10"><span class="loading loading-dots loading-lg"></span></div>';
        } else {
            isFetchingCustomerOrders = false; return;
        }
        history.pushState({path: historyUrl, tab: DEFAULT_CUSTOMER_ORDERS_TAB}, '', historyUrl);
        saveTabFiltersToSession(DEFAULT_CUSTOMER_ORDERS_TAB, currentCustomerOrderFilters);

        fetch(fetchUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
            .then(response => {
                if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
                const totalCountHeader = response.headers.get('X-Total-Orders-Count');
                if (totalCountHeader !== null) currentCustomerOrderFilters.total_orders_count = totalCountHeader;
                const hxTrigger = response.headers.get('HX-Trigger-After-Swap');
                const loadMoreContainer = document.getElementById('load-more-customer-orders-container');
                if (loadMoreContainer) loadMoreContainer.style.display = (hxTrigger === 'loadMoreCustomerOrdersAvailable') ? '' : 'none';
                return response.text();
            })
            .then(html => {
                if (dynamicContentContainer) {
                    dynamicContentContainer.innerHTML = html;
                    initializePackOrderButtons();
                    initializeEditOrderButtons();
                    initLoadMoreCustomerOrders();
                }
                updateCustomerOrderFiltersUI();
            })
            .catch(error => {
                if (dynamicContentContainer) dynamicContentContainer.innerHTML = '<div class="text-center py-10 text-red-500">Error loading orders.</div>';
            })
            .finally(() => { isFetchingCustomerOrders = false; });
    }
    const debouncedApplyCustomerOrderFilters = debounce(applyCustomerOrderFilters, 400);

    function bindCustomerOrderFilterControls() {
        const currentTabContent = document.getElementById('operation-tab-content');
        if (!currentTabContent) return;
        const filterPanel = currentTabContent.querySelector('.operations-filter-panel');
        if (!filterPanel || !currentTabContent.querySelector('#customer-orders-list-tbody') || filterPanel.dataset.customerOrderFilterBound === 'true') return;

        filterPanel.addEventListener('click', function(event) {
            const target = event.target.closest('button');
            if (!target || !target.closest('.operations-filter-panel')) return;
            let filtersChanged = false;
            if (target.classList.contains('warehouse-filter-btn')) {
                currentCustomerOrderFilters.warehouse = target.dataset.value; filtersChanged = true;
            } else if (target.classList.contains('status-filter-btn')) {
                currentCustomerOrderFilters.status = target.dataset.value; filtersChanged = true;
            } else if (target.classList.contains('reset-filters-btn')) {
                currentCustomerOrderFilters = { page: '1' };
                const searchInput = filterPanel.querySelector('.dynamic-search-input');
                if (searchInput) searchInput.value = "";
                filtersChanged = true; clearTabFiltersFromSession(DEFAULT_CUSTOMER_ORDERS_TAB);
            }
            if (filtersChanged) applyCustomerOrderFilters(true, "CO Button Click");
        });
        const searchInput = filterPanel.querySelector('.dynamic-search-input');
        if (searchInput && !searchInput.dataset.coListenerAttached) {
            searchInput.addEventListener('input', function() {
                if (!this.closest('.operations-filter-panel') || this.closest('.parcel-filters')) return;
                currentCustomerOrderFilters.q = this.value.trim();
                debouncedApplyCustomerOrderFilters(true, "CO Search Input");
            });
            searchInput.dataset.coListenerAttached = 'true';
        }
        filterPanel.dataset.customerOrderFilterBound = 'true';
    }

    function initLoadMoreCustomerOrders() {
        const currentTabContent = document.getElementById('operation-tab-content');
        if (!currentTabContent) return;
        const loadMoreBtn = currentTabContent.querySelector('#explore-more-customer-orders-btn');
        const loadMoreContainer = currentTabContent.querySelector('#load-more-customer-orders-container');
        const ordersTbody = currentTabContent.querySelector('#customer-orders-list-tbody');

        if (!loadMoreBtn || !loadMoreContainer || !ordersTbody) {
            if(loadMoreContainer) loadMoreContainer.style.display = 'none'; return;
        }
        if (loadMoreBtn.dataset.coListenerAttached === 'true') return;

        loadMoreBtn.addEventListener('click', function() {
            let currentPage = parseInt(currentCustomerOrderFilters.page || '1');
            const nextPage = currentPage + 1;

            const params = new URLSearchParams();
            if (currentCustomerOrderFilters.warehouse) params.set('warehouse', currentCustomerOrderFilters.warehouse);
            if (currentCustomerOrderFilters.status) params.set('status', currentCustomerOrderFilters.status);
            if (currentCustomerOrderFilters.q) params.set('q', currentCustomerOrderFilters.q);
            params.set('page', nextPage.toString());

            const fetchUrl = `/operation/customer-orders/load-more/?${params.toString()}`;

            loadMoreBtn.disabled = true; loadMoreBtn.innerHTML = '<span class="loading loading-spinner"></span> Loading...';

            fetch(fetchUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
            .then(response => {
                const trigger = response.headers.get('HX-Trigger');
                if (!response.ok) throw new Error('Network error loading more orders.');
                return response.text().then(html => ({html, trigger}));
            })
            .then(({html, trigger}) => {
                if (html.trim() !== "") {
                    ordersTbody.insertAdjacentHTML('beforeend', html);
                    currentCustomerOrderFilters.page = nextPage.toString();
                    saveTabFiltersToSession(DEFAULT_CUSTOMER_ORDERS_TAB, currentCustomerOrderFilters);
                    initializePackOrderButtons(); initializeEditOrderButtons();
                }
                loadMoreContainer.style.display = (trigger === 'loadMoreCustomerOrdersAvailable' && html.trim() !== "") ? '' : 'none';
            })
            .catch(error => { loadMoreContainer.style.display = 'none'; })
            .finally(() => { if (loadMoreContainer.style.display !== 'none') { loadMoreBtn.disabled = false; loadMoreBtn.innerHTML = 'Explore More Orders'; }});
        });
        loadMoreBtn.dataset.coListenerAttached = 'true';
    }

    function initializePackOrderButtons() {
        const currentTabContent = document.getElementById('operation-tab-content');
        if (!currentTabContent) return;

        currentTabContent.querySelectorAll('.pack-order-btn').forEach(button => {
            if (button.dataset.listenerAttached === 'true') return;

            button.addEventListener('click', function(event) {
                event.preventDefault();
                const orderPk = this.dataset.orderPk;
                if (!orderPk) return;

                const packModalToggle = document.getElementById('pack-order-modal-toggle');
                const packFormsetContainer = document.getElementById('pack-order-items-formset-container');
                const packModalTitle = document.getElementById('pack-modal-title');
                const packModalCustomer = document.getElementById('pack-modal-customer');
                const packForm = document.getElementById('pack-order-form');
                const orderPkHiddenInput = document.getElementById('order_pk_for_packing_modal_hidden_id');
                const dailyCourierCountsDisplay = document.getElementById('daily-courier-counts-display');
                const courierCountsList = document.getElementById('courier-counts-list');
                const courierSelectionButtonsDiv = document.getElementById('courier-selection-buttons');
                const hiddenCourierInput = document.getElementById('id_parcel-courier_id');
                const notesTextarea = document.getElementById('id_parcel-notes');
                const hiddenPackagingInput = document.getElementById('id_parcel-packaging_type');
                const packagingOptionsContainer = document.getElementById('packaging-options-container');

                if (!packModalToggle || !packFormsetContainer || !packModalTitle || !packModalCustomer || !packForm || !orderPkHiddenInput || !dailyCourierCountsDisplay || !courierCountsList || !courierSelectionButtonsDiv || !hiddenCourierInput || !hiddenPackagingInput || !packagingOptionsContainer) {
                    console.error("DEBUG: One or more modal elements could not be found. Please check all element IDs.");
                    return;
                }

                packFormsetContainer.innerHTML = '<p class="text-center py-4 text-gray-400">Fetching items...</p>';
                courierCountsList.innerHTML = '';
                dailyCourierCountsDisplay.style.display = 'none';
                courierSelectionButtonsDiv.innerHTML = '';
                hiddenCourierInput.value = '';
                hiddenPackagingInput.value = '';
                packagingOptionsContainer.innerHTML = '';
                notesTextarea.value = '';

                fetch(`/operation/order/${orderPk}/get-packing-items/`)
                    .then(response => response.ok ? response.json() : response.text().then(text => { throw new Error(text || `Server error: ${response.status}`);}))
                    .then(data => {
                        if (data.success) {
                            if (packModalTitle) packModalTitle.textContent = `Pack Order: ${data.erp_order_id || orderPk}`;
                            if (packModalCustomer) packModalCustomer.textContent = `Customer: ${data.customer_name || 'N/A'}`;
                            if (packFormsetContainer) packFormsetContainer.innerHTML = data.formset_html;
                            if (packForm) packForm.action = `/operation/order/${orderPk}/process-packing/`;
                            if (orderPkHiddenInput) orderPkHiddenInput.value = orderPk;
                            if (notesTextarea) notesTextarea.value = data.shipping_notes_for_parcel || '';

                            const isCold = data.is_cold_chain === true;
                            const coldStatusEl = document.getElementById('order-cold-chain-status-display');
                            if (coldStatusEl) {
                                coldStatusEl.textContent = isCold ? "Cold Chain" : "Ambient";
                                coldStatusEl.className = isCold ? "font-bold text-blue-600" : "font-bold text-green-600";
                            }

                            if (data.available_packaging) {
                                if (data.available_packaging.length > 0) {
                                    data.available_packaging.forEach(pkg => {
                                        const btn = document.createElement('button');
                                        btn.type = 'button';
                                        btn.className = 'btn btn-sm btn-outline packaging-btn';
                                        btn.dataset.packagingId = pkg.id;
                                        btn.textContent = pkg.name;
                                        packagingOptionsContainer.appendChild(btn);
                                    });
                                } else {
                                    packagingOptionsContainer.innerHTML = '<p class="text-xs text-gray-500 italic">No packaging types available.</p>';
                                }
                            }

                            if (courierSelectionButtonsDiv && data.available_couriers) {
                                if (data.available_couriers.length > 0) {
                                    data.available_couriers.forEach(courier => {
                                        const btn = document.createElement('button');
                                        btn.type = 'button';
                                        btn.className = 'btn btn-sm btn-outline courier-btn';
                                        btn.dataset.courierId = courier.id;
                                        btn.textContent = courier.name;
                                        courierSelectionButtonsDiv.appendChild(btn);
                                    });
                                } else {
                                    courierSelectionButtonsDiv.innerHTML = '<p class="text-xs text-gray-500">No couriers configured.</p>';
                                }
                            }

                            if (typeof setupDynamicBatchDropdowns === "function") {
                                setupDynamicBatchDropdowns();
                            }

                            if (typeof displayCourierDashboard === "function" && data.daily_courier_counts_object) {
                                displayCourierDashboard(data.daily_courier_counts_object, data.available_couriers);
                                if (dailyCourierCountsDisplay) dailyCourierCountsDisplay.style.display = 'block';
                            } else if (dailyCourierCountsDisplay) {
                                dailyCourierCountsDisplay.style.display = 'none';
                            }
                            if (packModalToggle) packModalToggle.checked = true;

                        } else {
                            if (packFormsetContainer) packFormsetContainer.innerHTML = `<p class="text-red-500 text-center py-3">${data.message || 'Failed to load packing items.'}</p>`;
                            if (typeof Swal !== 'undefined') Swal.fire('Info', data.message || 'Could not load items for packing.', 'info');
                        }
                    })
                    .catch(error => {
                        if (packFormsetContainer) packFormsetContainer.innerHTML = `<p class="text-red-500 text-center py-3">Error: ${error.message || 'Unknown fetch error'}</p>`;
                        if (typeof Swal !== 'undefined') Swal.fire('Error', `Could not fetch packing details: ${error.message || 'Unknown error'}`, 'error');
                    });
            });
            button.dataset.listenerAttached = 'true';
        });
    }

    const packOrderModalContent = document.getElementById('pack-order-modal-content');
    if (packOrderModalContent) {
        packOrderModalContent.addEventListener('click', function(e) {
            const courierBtn = e.target.closest('.courier-btn');
            const packagingBtn = e.target.closest('.packaging-btn');

            if (courierBtn) {
                e.preventDefault();
                const selectedCourierId = courierBtn.dataset.courierId;
                const hiddenCourierInput = document.getElementById('id_parcel-courier_id');
                if (hiddenCourierInput) {
                    hiddenCourierInput.value = selectedCourierId;
                }

                const parentDiv = courierBtn.closest('#courier-selection-buttons');
                if (parentDiv) {
                    parentDiv.querySelectorAll('.courier-btn').forEach(btn => {
                        btn.classList.remove('btn-active', 'btn-neutral');
                        btn.classList.add('btn-outline');
                    });
                }
                courierBtn.classList.add('btn-active', 'btn-neutral');
                courierBtn.classList.remove('btn-outline');
            }

            if (packagingBtn) {
                e.preventDefault();
                const selectedPackagingId = packagingBtn.dataset.packagingId;
                const hiddenPackagingInput = document.getElementById('id_parcel-packaging_type');
                if (hiddenPackagingInput) {
                    hiddenPackagingInput.value = selectedPackagingId;
                }
                const packagingOptionsContainer = packagingBtn.closest('#packaging-options-container');
                if(packagingOptionsContainer) {
                    packagingOptionsContainer.querySelectorAll('.packaging-btn').forEach(btn => {
                        btn.classList.toggle('btn-active', btn === packagingBtn);
                        btn.classList.toggle('btn-neutral', btn === packagingBtn);
                        btn.classList.toggle('btn-outline', btn !== packagingBtn);
                    });
                }
            }
        });
    }

    function initializeEditOrderButtons() {
        const currentContainer = document.getElementById('operation-tab-content');
        if (!currentContainer) return;

        currentContainer.querySelectorAll('.edit-order-btn').forEach(button => {
            if (button.dataset.editListenerAttached === 'true') return;

            button.addEventListener('click', function(event) {
                event.preventDefault();
                const orderPk = this.dataset.orderPk;
                const modalToggle = document.getElementById('edit-order-modal-toggle');
                const formsetContainer = document.getElementById('edit-order-items-formset-container');
                const modalTitle = document.getElementById('edit-modal-title');
                const customerInfo = document.getElementById('edit-modal-customer-info');
                const hiddenPkInput = document.getElementById('order_pk_for_editing_modal_hidden_id_js');
                const logDisplay = document.getElementById('removed-items-display');
                const formEl = document.getElementById('edit-order-form');

                if (!orderPk || !modalToggle || !formsetContainer || !modalTitle || !customerInfo || !formEl || !hiddenPkInput || !logDisplay) return;

                formsetContainer.innerHTML = '<p class="text-center py-4 text-gray-400">Fetching items...</p>';
                logDisplay.innerHTML = '<p class="text-sm text-gray-500">Loading removal log...</p>';

                fetch(`/operation/order/${orderPk}/get-items-for-editing/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            modalTitle.textContent = `Edit Items for Order: ${data.erp_order_id || orderPk}`;
                            customerInfo.textContent = `Customer: ${data.customer_name || 'N/A'}`;
                            formsetContainer.innerHTML = data.formset_html;
                            formEl.action = `/operation/order/${orderPk}/process-item-removal/`;
                            hiddenPkInput.value = orderPk;

                            if (data.removed_items_log && data.removed_items_log.length > 0) {
                                let logHtml = '<ul class="list-disc list-inside space-y-1">';
                                data.removed_items_log.forEach(log => {
                                    const removedAt = new Date(log.removed_at).toLocaleString('en-GB', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                                    logHtml += `<li class="border-b border-gray-200 pb-1 mb-1">SKU <strong>${log.product_sku||'N/A'}</strong>: ${log.removed_qty} removed on ${removedAt}</li>`;
                                });
                                logDisplay.innerHTML = logHtml + '</ul>';
                            } else {
                                logDisplay.innerHTML = '<p class="text-sm text-gray-500">No items previously removed for this order.</p>';
                            }
                            modalToggle.checked = true;
                        } else {
                            if (typeof Swal !== 'undefined') Swal.fire('Error', data.message || 'Could not load items for editing.', 'error');
                            else alert(data.message || 'Could not load items for editing.');
                            formsetContainer.innerHTML = `<p class="text-red-500 text-center py-3">${data.message || 'Failed to load items.'}</p>`;
                        }
                    })
                    .catch(error => {
                        if (typeof Swal !== 'undefined') Swal.fire('Error', 'An error occurred. Check console.', 'error');
                        formsetContainer.innerHTML = '<p class="text-red-500 text-center py-3">Error loading. Check console.</p>';
                    });
            });
            button.dataset.editListenerAttached = 'true';
        });
    }

    function setupDynamicBatchDropdowns() {
        const formsetContainer = document.getElementById('pack-order-items-formset-container');
        if (!formsetContainer) return;

        formsetContainer.querySelectorAll('.pack-items-table .pack-item-row').forEach(row => {
            const orderItemId = row.dataset.orderItemId;
            const batchSelect = row.querySelector('.available-batches-select');
            const hiddenSelectedBatchIdInput = row.querySelector('input[name$="-selected_batch_item_id"]');
            const initialSuggestedBatchId = hiddenSelectedBatchIdInput ? hiddenSelectedBatchIdInput.value : null;
            const errorPlaceholder = row.querySelector('.available-batches-error-placeholder');

            if (!orderItemId || !batchSelect || !hiddenSelectedBatchIdInput) {
                return;
            }

            batchSelect.innerHTML = '<option value="">Loading batches...</option>';
            if (errorPlaceholder) errorPlaceholder.textContent = '';

            fetch(`/operation/order-item/${orderItemId}/get-available-batches/`)
                .then(response => response.ok ? response.json() : response.text().then(text => { throw new Error(text || `Server error fetching batches: ${response.status}`); }))
                .then(data => {
                    batchSelect.innerHTML = '<option value="">--- Select Batch ---</option>';
                    if (data.success && data.batches && data.batches.length > 0) {
                        data.batches.forEach(batch => {
                            const option = new Option(batch.display_name, batch.id);
                            option.dataset.quantityAvailable = batch.quantity_available;
                            batchSelect.add(option);
                        });

                        if (initialSuggestedBatchId && batchSelect.querySelector(`option[value="${initialSuggestedBatchId}"]`)) {
                            batchSelect.value = initialSuggestedBatchId;
                            hiddenSelectedBatchIdInput.value = initialSuggestedBatchId;
                        } else if (initialSuggestedBatchId) {
                            hiddenSelectedBatchIdInput.value = '';
                            if (errorPlaceholder) errorPlaceholder.textContent = 'Note: Previously suggested batch may no longer be suitable or available.';
                        } else {
                             hiddenSelectedBatchIdInput.value = '';
                        }

                    } else {
                        const message = data.message || 'No suitable batches found.';
                        batchSelect.innerHTML = `<option value="">${message}</option>`;
                        if (errorPlaceholder) errorPlaceholder.textContent = message;
                        hiddenSelectedBatchIdInput.value = '';
                    }
                })
                .catch(error => {
                    batchSelect.innerHTML = '<option value="">Error loading batches</option>';
                    if (errorPlaceholder) errorPlaceholder.textContent = `Client-side error: ${error.message}`;
                    hiddenSelectedBatchIdInput.value = '';
                });

            if (!batchSelect.dataset.listenerAttachedBatchChange) {
                batchSelect.addEventListener('change', function() {
                    if (hiddenSelectedBatchIdInput) {
                        hiddenSelectedBatchIdInput.value = this.value;
                    }
                    if(errorPlaceholder) errorPlaceholder.textContent = '';
                });
                batchSelect.dataset.listenerAttachedBatchChange = 'true';
            }
        });
    }

    function updateParcelFiltersUI() {
        const parcelFilterPanel = tabContainer.querySelector('.parcel-filters');
        if (!parcelFilterPanel || !tabContainer.querySelector('#parcels-list-tbody')) return;

        const activeWarehouse = currentParcelFilters.parcel_warehouse || "";
        parcelFilterPanel.querySelectorAll('.parcel-warehouse-filter-btn').forEach(btn => {
            btn.classList.toggle('btn-neutral', btn.dataset.value === activeWarehouse);
            btn.classList.toggle('text-white', btn.dataset.value === activeWarehouse);
            btn.classList.toggle('btn-outline', btn.dataset.value !== activeWarehouse);
        });
        const activeCourier = currentParcelFilters.parcel_courier || "";
        parcelFilterPanel.querySelectorAll('.parcel-courier-filter-btn').forEach(btn => {
            btn.classList.toggle('btn-neutral', btn.dataset.value === activeCourier);
            btn.classList.toggle('text-white', btn.dataset.value === activeCourier);
            btn.classList.toggle('btn-outline', btn.dataset.value !== activeCourier);
        });
        const searchInput = parcelFilterPanel.querySelector('.parcel-dynamic-search-input');
        if (searchInput && searchInput.value !== (currentParcelFilters.parcel_q || "")) searchInput.value = currentParcelFilters.parcel_q || "";

        const parcelCountSpan = parcelFilterPanel.querySelector('.parcel-count-display');
        if (parcelCountSpan && currentParcelFilters.total_parcels_count !== undefined) parcelCountSpan.textContent = `(${currentParcelFilters.total_parcels_count} parcels)`;
    }

    function loadInitialParcelFilters(urlParams) {
        const sessionFilters = loadTabFiltersFromSession(DEFAULT_PARCELS_TAB);
        currentParcelFilters.parcel_warehouse = urlParams.get('parcel_warehouse') || sessionFilters.get('parcel_warehouse') || "";
        currentParcelFilters.parcel_courier = urlParams.get('parcel_courier') || sessionFilters.get('parcel_courier') || "";
        currentParcelFilters.parcel_q = urlParams.get('parcel_q') || sessionFilters.get('parcel_q') || "";
        currentParcelFilters.page = urlParams.get('page') || sessionFilters.get('page') || '1';
        // 'fetch_parcel_list_only' is not loaded from URL/session, it's for specific fetch calls
        updateParcelFiltersUI();
    }

    function applyParcelFilters(resetPage = true, caller="unknown_parcel_caller") {
        if (isFetchingParcels) return; isFetchingParcels = true;
        if (resetPage) currentParcelFilters.page = '1';

        const params = new URLSearchParams();
        params.set('tab', DEFAULT_PARCELS_TAB);
        if (currentParcelFilters.parcel_warehouse) params.set('parcel_warehouse', currentParcelFilters.parcel_warehouse);
        if (currentParcelFilters.parcel_courier) params.set('parcel_courier', currentParcelFilters.parcel_courier);
        if (currentParcelFilters.parcel_q) params.set('parcel_q', currentParcelFilters.parcel_q);
        params.set('page', currentParcelFilters.page);
        params.set('fetch_parcel_list_only', 'true'); // Crucial: Fetch only the list content
        const fetchUrl = `${currentBaseUrl}?${params.toString()}`;

        const parcelTableContainer = document.getElementById('parcels-table-container');
        if (parcelTableContainer) parcelTableContainer.innerHTML = '<div class="text-center py-10"><span class="loading loading-dots loading-lg"></span></div>';
        else { isFetchingParcels = false; return; }

        const paramsForHistory = new URLSearchParams(params);
        paramsForHistory.delete('fetch_parcel_list_only'); // Don't put helper param in URL history
        if (paramsForHistory.get('page') === '1') paramsForHistory.delete('page');
        const historyUrl = `${currentBaseUrl}?${paramsForHistory.toString()}`;

        history.pushState({path: historyUrl, tab: DEFAULT_PARCELS_TAB}, '', historyUrl);
        saveTabFiltersToSession(DEFAULT_PARCELS_TAB, currentParcelFilters); // Save all current filters (excluding fetch_parcel_list_only)

        fetch(fetchUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest', 'HX-Request': 'true' }})
            .then(response => {
                if (!response.ok) throw new Error('Network error fetching parcels.');
                const totalCountHeader = response.headers.get('X-Total-Parcels-Count');
                if (totalCountHeader !== null) currentParcelFilters.total_parcels_count = totalCountHeader;
                return response.text();
            })
            .then(html => {
                if (parcelTableContainer) {
                    parcelTableContainer.innerHTML = html; // This HTML is now only _parcels_list_content.html
                    bindParcelPaginationButtons();
                    initializeViewEditParcelModalButtons();
                }
                // `loadInitialParcelFilters` updates currentParcelFilters based on URL/session, which might not be what we want here.
                // We only need to update the UI to reflect potentially new counts.
                updateParcelFiltersUI();
            })
            .catch(error => { if (parcelTableContainer) parcelTableContainer.innerHTML = '<p class="text-red-500">Error loading parcels.</p>';})
            .finally(() => { isFetchingParcels = false; });
    }
    const debouncedApplyParcelFilters = debounce(applyParcelFilters, 400);


    // Removed the `bindParcelFilterControls` function. Event delegation is now used.

    function bindParcelPaginationButtons() {
        const currentTabContent = document.getElementById('operation-tab-content');
        if (!currentTabContent) return;
        const paginationControls = currentTabContent.querySelector('.parcel-pagination-controls');
        if (!paginationControls) return;

        paginationControls.querySelectorAll('.parcel-page-btn').forEach(button => {
            if (button.dataset.pageListenerAttached === 'true') return;
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const page = this.dataset.page;
                if (page) {
                    currentParcelFilters.page = page;
                    applyParcelFilters(false, `Parcel Page ${page} Click`);
                }
            });
            button.dataset.pageListenerAttached = 'true';
        });
    }

    function initializeViewEditParcelModalButtons() {
        const tabContent = document.getElementById('operation-tab-content');
        if (!tabContent) {
            return;
        }
        if (!tabContent.dataset.parcelEditListenerAttached) {
            tabContent.addEventListener('click', handleViewEditParcelButtonClick);
            tabContent.dataset.parcelEditListenerAttached = 'true';
        }
    }

    function handleViewEditParcelButtonClick(event) {
        const button = event.target.closest('.view-edit-parcel-btn');
        if (button) {
            event.preventDefault();
            const parcelPk = button.dataset.parcelPk;
            if (parcelPk) {
                openViewEditParcelModal(parcelPk);
            }
        }
    }

    function openViewEditParcelModal(parcelPk) {
        const modalContentArea = document.getElementById('view-edit-parcel-modal-content-area');
        const modalToggle = document.getElementById('view-edit-parcel-modal-toggle');
        const modalTitle = document.getElementById('view-edit-parcel-modal-title');

        if (!modalContentArea || !modalToggle || !modalTitle) {
            console.error("Modal elements not found");
            return;
        }

        modalTitle.textContent = `View/Edit Parcel Details (ID: ${parcelPk})`;
        modalContentArea.innerHTML = '<div class="flex justify-center items-center h-32"><span class="loading loading-dots loading-lg"></span><p class="ml-2">Loading parcel details...</p></div>';
        if(modalToggle) modalToggle.checked = true;

        let lengthInput, widthInput, heightInput;
        let dimensionalWeightResultSpan, dimensionalWeightHiddenInput;

        function _getElements() {
            const parcelEditForm = modalContentArea.querySelector('#view-edit-parcel-detail-form');
            if (!parcelEditForm) return false;

            lengthInput = parcelEditForm.querySelector('#id_parcel_length_form');
            widthInput = parcelEditForm.querySelector('#id_parcel_width_form');
            heightInput = parcelEditForm.querySelector('#id_parcel_height_form');
            dimensionalWeightResultSpan = parcelEditForm.querySelector('#dimensional-weight-result');
            dimensionalWeightHiddenInput = parcelEditForm.querySelector('#id_dimensional_weight_kg');

            return true;
        }

        function calculateAndDisplayDimWeight() {
            if (!_getElements()) return;

            const length = parseFloat(lengthInput ? lengthInput.value : 0) || 0;
            const width = parseFloat(widthInput ? widthInput.value : 0) || 0;
            const height = parseFloat(heightInput ? heightInput.value : 0) || 0;

            if (dimensionalWeightResultSpan) {
                if (length > 0 && width > 0 && height > 0) {
                    const dimWeight = (length * width * height) / 5000;
                    dimensionalWeightResultSpan.textContent = `${dimWeight.toFixed(2)} kg`;
                    if (dimensionalWeightHiddenInput) {
                        dimensionalWeightHiddenInput.value = dimWeight.toFixed(2);
                    }
                } else {
                    dimensionalWeightResultSpan.textContent = '0.00 kg';
                    if (dimensionalWeightHiddenInput) {
                        dimensionalWeightHiddenInput.value = '';
                    }
                }
            }
        }

        fetch(`/operation/parcel/${parcelPk}/get-details-for-editing/`)
            .then(response => {
                if (!response.ok) throw new Error(`Failed to fetch parcel details. Status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    modalContentArea.innerHTML = data.form_html;
                    if (_getElements()) {
                        if (data.parcel_data && data.parcel_data.parcel_code_system) {
                            modalTitle.textContent = `View/Edit Parcel: ${data.parcel_data.parcel_code_system}`;
                        }
                        const parcelEditForm = modalContentArea.querySelector('#view-edit-parcel-detail-form');
                        if (parcelEditForm) {
                            parcelEditForm.addEventListener('submit', (e) => handleParcelCustomsFormSubmit(e, parcelPk));
                            [lengthInput, widthInput, heightInput].forEach(input => {
                                if (input) {
                                    input.addEventListener('input', calculateAndDisplayDimWeight);
                                }
                            });
                            calculateAndDisplayDimWeight();
                        }
                    } else {
                        console.error("Could not find form elements after loading HTML.");
                    }
                } else {
                    modalContentArea.innerHTML = `<p class="text-red-500 text-center p-4">Error: ${data.message || 'Could not load details.'}</p>`;
                }
            })
            .catch(error => {
                console.error("Fetch error:", error);
                modalContentArea.innerHTML = `<p class="text-red-500 text-center p-4">Error fetching details: ${error.message}</p>`;
            });
    }



    function handleParcelCustomsFormSubmit(event, parcelPk) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const saveButton = form.querySelector('button[type="submit"]');
        const originalButtonText = saveButton ? saveButton.textContent : 'Save Customs Details';

        if (saveButton) {
            saveButton.disabled = true;
            saveButton.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Saving...';
        }

        fetch(`/operation/parcel/${parcelPk}/update-customs-details/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (typeof Swal !== 'undefined') {
                    Swal.fire({ toast: true, icon: 'success', title: data.message || 'Parcel details updated!', position: 'top-end', showConfirmButton: false, timer: 2500 });
                } else {
                    alert(data.message || 'Parcel details updated!');
                }
                const modalToggle = document.getElementById('view-edit-parcel-modal-toggle');
                if (modalToggle) modalToggle.checked = false;

                if (typeof applyParcelFilters === "function") {
                     applyParcelFilters(false, "Parcel Edit Success");
                } else {
                    const currentTab = getCurrentTabNameFromUrl();
                    if (typeof loadTabContent === "function" && currentTab === DEFAULT_PARCELS_TAB) {
                        const paramsForTarget = loadTabFiltersFromSession(DEFAULT_PARCELS_TAB);
                        paramsForTarget.set("tab", DEFAULT_PARCELS_TAB);
                        loadTabContent(`${currentBaseUrl}?${paramsForTarget.toString()}`, false);
                    }
                }
            } else {
                let errorMsg = data.message || 'Update failed.';
                if (data.errors) {
                    let errorsHtml = '<ul class="text-left list-disc list-inside">';
                    if (data.errors.parcel_form) {
                        try {
                            const pFormErrors = JSON.parse(data.errors.parcel_form);
                            for (const field in pFormErrors) {
                                errorsHtml += `<li><strong>Parcel - ${field.replace(/_/g, " ")}:</strong> ${pFormErrors[field].join(', ')}</li>`;
                            }
                        } catch(e) { errorsHtml += `<li>Parcel form errors exist (could not parse details).</li>`;}
                    }
                    if (data.errors.item_formset && Array.isArray(data.errors.item_formset)) {
                         data.errors.item_formset.forEach((form_err_json, idx) => {
                             if(form_err_json){
                                try {
                                    const err = JSON.parse(form_err_json);
                                    for(const field in err){
                                        errorsHtml += `<li><strong>Item ${idx+1} - ${field.replace(/_/g, " ")}:</strong> ${err[field].join(', ')}</li>`;
                                    }
                                } catch(e){ errorsHtml += `<li>Item ${idx+1} had errors (could not parse details).</li>`;}
                             }
                         });
                    }
                    if(data.errors.item_formset_non_form && data.errors.item_formset_non_form.length > 0) {
                        errorsHtml += `<li><strong>General Item Errors:</strong> ${data.errors.item_formset_non_form.join(', ')}</li>`;
                    }
                    errorsHtml += '</ul>';
                    if (errorsHtml !== '<ul class="text-left list-disc list-inside"></ul>') errorMsg = errorsHtml;
                }
                 if (typeof Swal !== 'undefined') Swal.fire({ icon: 'error', title: 'Update Failed', html: errorMsg });
                else alert(data.message || 'Update failed. Check console for details.');
            }
        })
        .catch(error => {
            if (typeof Swal !== 'undefined') Swal.fire({ icon: 'error', title: 'Network Error', text: `Could not submit form: ${error.message}` });
            else alert(`Network error: ${error.message}`);
        })
        .finally(() => {
            if (saveButton) {
                saveButton.disabled = false;
                saveButton.innerHTML = originalButtonText;
            }
        });
    }

    function highlightActiveTab(activeTabName) {
        mainPageTabs.forEach(tabLink => {
            const tabLinkName = tabLink.dataset.tab;
            const isActive = tabLinkName === activeTabName;
            tabLink.classList.toggle('tab-active', isActive);
            tabLink.classList.toggle('bg-blue-500', isActive);
            tabLink.classList.toggle('text-white', isActive);
            tabLink.classList.toggle('bg-gray-200', !isActive);
            tabLink.classList.toggle('text-gray-700', !isActive);
            tabLink.classList.toggle('hover:bg-gray-300', !isActive);
        });
    }

    function loadTabContent(url, isTabClick = false, isInitialLoad = false) { /* ... same as before (main logic) ... */
        const urlObj = new URL(url, window.location.origin); const tabName = urlObj.searchParams.get('tab') || DEFAULT_ORDER_MGMT_TAB;
        if (tabContainer) tabContainer.innerHTML = '<div class="text-center py-20"><span class="loading loading-ball loading-lg"></span></div>'; else return;
        // For loadTabContent, we ensure 'fetch_parcel_list_only' is NOT sent, so server returns full parcels_table.html
        urlObj.searchParams.delete('fetch_parcel_list_only');
        const finalFetchUrl = urlObj.toString();

        fetch(finalFetchUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest', 'HX-Request': 'true' }})
            .then(response => { if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                const totalCO = response.headers.get('X-Total-Orders-Count'), totalP = response.headers.get('X-Total-Parcels-Count'), hxT = response.headers.get('HX-Trigger-After-Swap');
                return response.text().then(html => ({html, totalCO, totalP, hxT }));
            })
            .then(({html, totalCO, totalP, hxT}) => {
                if (tabContainer) tabContainer.innerHTML = html; highlightActiveTab(tabName);
                if (isTabClick || isInitialLoad) history.pushState({path: finalFetchUrl, tab: tabName}, '', finalFetchUrl);
                if (tabName === DEFAULT_CUSTOMER_ORDERS_TAB) { if(totalCO!==null)currentCustomerOrderFilters.total_orders_count=totalCO; const lmc=document.getElementById('load-more-customer-orders-container'); if(lmc)lmc.style.display=(hxT==='loadMoreCustomerOrdersAvailable')?'':'none'; loadInitialCustomerOrderFilters(urlObj.searchParams); bindCustomerOrderFilterControls(); initLoadMoreCustomerOrders(); }
                else if (tabName === DEFAULT_PARCELS_TAB) { if(totalP!==null)currentParcelFilters.total_parcels_count=totalP; loadInitialParcelFilters(urlObj.searchParams); /* bindParcelFilterControls() removed - handled by delegation */ bindParcelPaginationButtons(); initializeViewEditParcelModalButtons(); }
                initializePackOrderButtons(); initializeEditOrderButtons();
                if(isInitialLoad) saveTabFiltersToSession(tabName, tabName===DEFAULT_CUSTOMER_ORDERS_TAB ? currentCustomerOrderFilters : currentParcelFilters);
            }).catch(error => { if (tabContainer) tabContainer.innerHTML = `<p class="text-red-500">Error loading ${tabName}: ${error.message}</p>`;});
    }

    // Event delegation for Parcel Filters (attached ONCE to tabContainer)
    if (tabContainer && !tabContainer.dataset.parcelFilterDelegationAttached) { /* ... same as before ... */
        tabContainer.addEventListener('click', function(event) {
            const target = event.target.closest('button');
            if (!target || !target.closest('.parcel-filters') || getCurrentTabNameFromUrl() !== DEFAULT_PARCELS_TAB) return;
            let filtersChanged = false;
            if (target.classList.contains('parcel-warehouse-filter-btn')) { currentParcelFilters.parcel_warehouse = target.dataset.value; filtersChanged = true; }
            else if (target.classList.contains('parcel-courier-filter-btn')) { currentParcelFilters.parcel_courier = target.dataset.value; filtersChanged = true; }
            else if (target.classList.contains('parcel-reset-filters-btn')) {
                currentParcelFilters = { page: '1', parcel_warehouse: '', parcel_courier: '', parcel_q: '' };
                const searchInput = tabContainer.querySelector('.parcel-filters .parcel-dynamic-search-input');
                if (searchInput) searchInput.value = ""; filtersChanged = true; sessionStorage.removeItem(`tabFilters_${DEFAULT_PARCELS_TAB}`);
            }
            if (filtersChanged) applyParcelFilters(true, "Parcel Delegated Button Click");
        });
        tabContainer.addEventListener('input', function(event) {
            const searchInput = event.target.closest('.parcel-dynamic-search-input');
            if (searchInput && searchInput.closest('.parcel-filters') && getCurrentTabNameFromUrl() === DEFAULT_PARCELS_TAB) {
                currentParcelFilters.parcel_q = searchInput.value.trim(); debouncedApplyParcelFilters(true, "Parcel Delegated Search Input");
            }
        });
        tabContainer.dataset.parcelFilterDelegationAttached = 'true';
    }

    mainPageTabs.forEach(tab => { /* ... same as before, ensuring fetch_parcel_list_only is removed from URL for full tab loads ... */
        if (tab.dataset.tabListenerAttached === 'true') return;
        tab.addEventListener("click", function (e) {
            e.preventDefault(); const targetTabName = this.dataset.tab; const currentActiveTab = getCurrentTabNameFromUrl();
            if (currentActiveTab && currentActiveTab !== targetTabName) {
                let stateToSaveOnClick = {};
                if (currentActiveTab === DEFAULT_CUSTOMER_ORDERS_TAB) stateToSaveOnClick = currentCustomerOrderFilters;
                else if (currentActiveTab === DEFAULT_PARCELS_TAB) stateToSaveOnClick = currentParcelFilters;
                saveTabFiltersToSession(currentActiveTab, stateToSaveOnClick);
            }
            const paramsForTarget = loadTabFiltersFromSession(targetTabName);
            paramsForTarget.set("tab", targetTabName);
            if((ORDER_MGMT_TAB_SPECIFIC_PARAMS[targetTabName]||[]).includes('page')&&!paramsForTarget.has('page'))paramsForTarget.set('page','1');
            paramsForTarget.delete('fetch_parcel_list_only'); // Ensure full tab load
            loadTabContent(`${currentBaseUrl}?${paramsForTarget.toString()}`, true);
        });
        tab.dataset.tabListenerAttached = 'true';
    });

    window.onpopstate = function(event) { /* ... same as before, ensuring fetch_parcel_list_only is removed ... */
        let poppedUrl = (event.state && event.state.path) ? event.state.path : `${currentBaseUrl}?tab=${DEFAULT_ORDER_MGMT_TAB}`;
        const urlParams = new URLSearchParams(poppedUrl.split('?')[1] || '');
        urlParams.delete('fetch_parcel_list_only');
        loadTabContent(`${currentBaseUrl}?${urlParams.toString()}`, false);
    };

    // Initial page load logic: Ensure 'fetch_parcel_list_only' is not part of the initial URL.
    const initialUrlParamsCleaned = new URLSearchParams(window.location.search); /* ... rest of initial load logic same as before, ensuring fetch_parcel_list_only is removed ... */
    initialUrlParamsCleaned.delete('fetch_parcel_list_only');
    let initialTab = initialUrlParamsCleaned.get('tab') || DEFAULT_ORDER_MGMT_TAB;
    if (window.location.pathname.endsWith('/order_management_base/') && !initialUrlParamsCleaned.has('tab') && window.location.search.length <=1 ) {
        clearAllTabFiltersFromSession(); initialTab = DEFAULT_ORDER_MGMT_TAB; const newParams = new URLSearchParams();
        newParams.set('tab', initialTab); if((ORDER_MGMT_TAB_SPECIFIC_PARAMS[initialTab]||[]).includes('page'))newParams.set('page','1');
        const freshLoadUrl = `${currentBaseUrl}?${newParams.toString()}`; history.replaceState({path:freshLoadUrl,tab:initialTab},'',freshLoadUrl); loadTabContent(freshLoadUrl,false,true);
    } else {
        const sessionP = loadTabFiltersFromSession(initialTab); const combinedP = new URLSearchParams(initialUrlParamsCleaned);
        sessionP.forEach((v,k)=>{if(!combinedP.has(k))combinedP.set(k,v);}); if(!combinedP.has('tab'))combinedP.set('tab',initialTab);
        if((ORDER_MGMT_TAB_SPECIFIC_PARAMS[initialTab]||[]).includes('page')&&!combinedP.has('page'))combinedP.set('page','1');
        combinedP.delete('fetch_parcel_list_only');
        const finalUrl = `${currentBaseUrl}?${combinedP.toString()}`; history.replaceState({path:finalUrl,tab:initialTab},'',finalUrl); loadTabContent(finalUrl,false,true);
    }

    const importModalToggle = document.getElementById('import-orders-modal-toggle');
    const importFileInput = document.querySelector('.modal input[type="file"][name="excel_file"]');
    if (importModalToggle && importFileInput) {
        const observer = new MutationObserver((mutationsList) => {
            for (const mutation of mutationsList) {
                if (mutation.attributeName === 'checked' && !importModalToggle.checked) {
                    importFileInput.value = '';
                }
            }
        });
        observer.observe(importModalToggle, { attributes: true });
    }

    const packOrderModalContainer = document.getElementById('pack-order-modal-container');
    if (packOrderModalContainer) {
        packOrderModalContainer.addEventListener('click', function(e) {
            const courierBtn = e.target.closest('.courier-btn');
            const packagingBtn = e.target.closest('.packaging-btn');

            if (courierBtn) {
                e.preventDefault();
                const selectedCourierId = courierBtn.dataset.courierId;
                const hiddenCourierInput = document.getElementById('id_parcel-courier_id');
                if (hiddenCourierInput) hiddenCourierInput.value = selectedCourierId;

                document.querySelectorAll('#courier-selection-buttons .courier-btn').forEach(btn => {
                    const isActive = btn === courierBtn && selectedCourierId !== "";
                    btn.classList.toggle('btn-active', isActive);
                    btn.classList.toggle('btn-neutral', isActive);
                    btn.classList.toggle('btn-outline', !isActive);
                });
            }

            if (packagingBtn) {
                e.preventDefault();
                const selectedPackaging = packagingBtn.dataset.packagingId;
                const hiddenPackagingInput = document.getElementById('id_parcel-packaging_type');
                if (hiddenPackagingInput) hiddenPackagingInput.value = selectedPackaging;

                document.querySelectorAll('.packaging-btn').forEach(btn => {
                    const isActive = btn === packagingBtn && selectedPackaging !== "";
                    btn.classList.toggle('btn-active', isActive);
                    btn.classList.toggle('btn-neutral', isActive);
                    btn.classList.toggle('btn-outline', !isActive);
                });
            }
        });
    }

    const packForm = document.getElementById('pack-order-form');
    if (packForm) {
        packForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(packForm);
            const saveBtn = packForm.querySelector('button[type="submit"]');
            const originalBtnText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="loading loading-spinner"></span> Processing...';

            fetch(packForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if(typeof Swal !== 'undefined') Swal.fire({toast: true, icon: 'success', title: data.message || 'Parcel created!', position: 'top-end', showConfirmButton: false, timer: 2500});
                    const packModalToggle = document.getElementById('pack-order-modal-toggle');
                    if(packModalToggle) packModalToggle.checked = false;
                    packForm.reset();

                    const currentTab = getCurrentTabNameFromUrl();
                    const paramsForRefresh = loadTabFiltersFromSession(currentTab);
                    paramsForRefresh.set('tab', currentTab);
                     if ((ORDER_MGMT_TAB_SPECIFIC_PARAMS[currentTab] || []).includes('page') && !paramsForRefresh.has('page')){
                         paramsForRefresh.set('page', '1');
                     }

                    if (typeof loadTabContent === "function") {
                         loadTabContent(`${currentBaseUrl}?${paramsForRefresh.toString()}`, false);
                    } else {
                        window.location.reload();
                    }

                } else {
                    let errorMsg = data.message || 'Could not create parcel.';
                    if (data.errors) {
                        errorMsg += " Details: " + (typeof data.errors === 'string' ? data.errors : JSON.stringify(data.errors));
                    }
                    if(typeof Swal !== 'undefined') Swal.fire({ icon: 'error', title: 'Packing Failed', text: errorMsg });
                    else alert(errorMsg);
                }
            })
            .catch(error => {
                if(typeof Swal !== 'undefined') Swal.fire({ icon: 'error', title: 'Network Error', text: 'Could not submit packing form.'});
                else alert('Network error during packing.');
            })
            .finally(() => {
                if(saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = originalBtnText; }
            });
        });
    }

    const editOrderForm = document.getElementById('edit-order-form');
    if (editOrderForm) {
        editOrderForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(editOrderForm);
            const saveBtn = editOrderForm.querySelector('button[type="submit"]');
            const originalBtnText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="loading loading-spinner"></span> Processing...';

            fetch(editOrderForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if(typeof Swal !== 'undefined') Swal.fire({toast: true, icon: 'success', title: data.message || 'Order updated!', position: 'top-end', showConfirmButton: false, timer: 2500});
                    const editModalToggle = document.getElementById('edit-order-modal-toggle');
                    if(editModalToggle) editModalToggle.checked = false;
                    editOrderForm.reset();

                    const activeTab = getCurrentTabNameFromUrl();
                    if (activeTab === DEFAULT_CUSTOMER_ORDERS_TAB && typeof applyCustomerOrderFilters === "function") {
                        applyCustomerOrderFilters(false, "EditForm Success");
                    } else if (activeTab === DEFAULT_CUSTOMER_ORDERS_TAB){
                        const paramsForRefresh = loadTabFiltersFromSession(DEFAULT_CUSTOMER_ORDERS_TAB);
                        paramsForRefresh.set('tab', DEFAULT_CUSTOMER_ORDERS_TAB);
                        if (!paramsForRefresh.has('page')) paramsForRefresh.set('page', '1');
                        loadTabContent(`${currentBaseUrl}?${paramsForRefresh.toString()}`, false);
                    }
                }  else {
                    let errorMsg = data.message || 'Could not update order items.';
                    if (data.errors) {
                        errorMsg += " Details: " + (typeof data.errors === 'string' ? data.errors : JSON.stringify(data.errors));
                    }
                    if(typeof Swal !== 'undefined') Swal.fire({ icon: 'error', title: 'Update Failed', text: errorMsg });
                    else alert(errorMsg);
                }
            })
            .catch(error => {
                if(typeof Swal !== 'undefined') Swal.fire({ icon: 'error', title: 'Network Error', text: 'Could not submit item removal form. (' + error.message + ')'});
                else alert('Network error during item removal. (' + error.message + ')');
            })
            .finally(() => {
                if(saveBtn) { saveBtn.disabled = false; saveBtn.innerHTML = originalBtnText; }
            });
        });
    }

});
</script>
{% endblock %}
