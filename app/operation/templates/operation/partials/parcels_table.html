{# app/operation/templates/operation/partials/parcels_table.html #}
{% load i18n %}
{% load humanize %}

<form method="get" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 items-end mb-6">
    <input type="hidden" name="tab" value="{{ DEFAULT_PARCELS_TAB }}">
    <div>
        <label for="p_warehouse_filter" class="block text-sm font-medium text-gray-700 mb-1">Warehouse</label>
        <select name="parcel_warehouse" id="p_warehouse_filter" class="select select-sm select-bordered w-full">
            <option value="">All Warehouses</option>
            {% for wh in warehouses %}
                <option value="{{ wh.pk }}" {% if selected_parcel_warehouse == wh.pk|stringformat:"s" %}selected{% endif %}>{{ wh.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="sm:col-span-1 md:col-span-1">
        <label for="p_search_input" class="block text-sm font-medium text-gray-700 mb-1">Search Parcels</label>
        <input type="text" name="parcel_q" id="p_search_input" value="{{ parcel_query|default:'' }}" placeholder="Parcel Code, Tracking, Order ID, SKU..." class="input input-sm input-bordered w-full">
    </div>
    <div class="text-right sm:col-span-full md:col-span-1 pt-3 md:pt-0">
         <button type="submit" class="btn btn-sm btn-neutral w-full md:w-auto">Filter / Search</button>
         <a href="?tab={{ DEFAULT_PARCELS_TAB }}" class="btn btn-sm btn-outline w-full md:w-auto mt-2 md:mt-0 md:ml-2">Reset</a>
    </div>
</form>

{% if parcels %}
    <div class="overflow-x-auto bg-white shadow-md rounded-lg">
        <table class="min-w-full table-auto main-parcel-table table-sm">
            <thead class="bg-gray-100 text-gray-700 uppercase text-xs leading-normal">
                <tr>
                    <th class="py-2 px-4 text-left">Parcel Code</th>
                    <th class="py-2 px-4 text-left">Order (LWA ID)</th>
                    <th class="py-2 px-4 text-left">Customer</th>
                    <th class="py-2 px-4 text-left">Courier</th>
                    <th class="py-2 px-4 text-left">Tracking #</th>
                    <th class="py-2 px-4 text-left">Items in Parcel (Location | Product | Batch)</th> {# Changed Header #}
                    <th class="py-2 px-4 text-left">Picked Up At</th>
                    <th class="py-2 px-4 text-left">Created At</th>
                    <th class="py-2 px-4 text-left">Actions</th>
                </tr>
            </thead>
            <tbody class="text-gray-600 text-sm">
                {% for parcel in parcels %}
                    <tr class="parcel-row border-b border-gray-200 hover:bg-gray-50" data-parcel-id="{{ parcel.pk }}">
                        <td class="py-2 px-4 text-left align-top">
                            <span class="font-semibold text-primary">{{ parcel.parcel_code_system|default:"N/A" }}</span>
                        </td>
                        <td class="py-2 px-4 text-left align-top">
                            {{ parcel.order.erp_order_id|default:"N/A" }}
                            <br><small class="text-gray-500">WH: {{ parcel.order.warehouse.name|default:"-"}}</small>
                        </td>
                        <td class="py-2 px-4 text-left align-top">
                            {{ parcel.order.customer_name|default:"N/A" }}
                            {% if parcel.order.company_name %}<br><small class="text-gray-500">{{ parcel.order.company_name }}</small>{% endif %}
                        </td>
                        <td class="py-2 px-4 text-left align-top">{{ parcel.courier_name|default:"-" }}</td>
                        <td class="py-2 px-4 text-left align-top">{{ parcel.tracking_number|default:"-" }}</td>
                        <td class="py-2 px-4 text-left align-top">
                            {% if parcel.items_in_parcel.all %}
                                <table class="table table-xs w-full"><tbody>
                                {% for p_item in parcel.items_in_parcel.all %}
                                    <tr>
                                        <td class="px-1 py-0.5 w-1/12 whitespace-nowrap">{{ p_item.quantity_shipped_in_this_parcel }}x</td>
                                        <td class="px-1 py-0.5 w-auto">
                                            {% if p_item.shipped_from_batch and p_item.shipped_from_batch.location_label %}
                                                <span class="text-blue-600 font-medium">[{{ p_item.shipped_from_batch.location_label }}]</span>
                                            {% else %}
                                                <span class="text-gray-400 font-medium">[NoLoc]</span>
                                            {% endif %}
                                            {{ p_item.order_item.product.name|default:p_item.order_item.erp_product_name|truncatechars:30 }}
                                            {% if p_item.shipped_from_batch and p_item.shipped_from_batch.batch_number %}
                                                <span class="text-green-700 font-medium ml-1">[{{ p_item.shipped_from_batch.batch_number }}]</span>
                                            {% elif p_item.shipped_from_batch %}
                                                <span class="text-gray-400 font-medium ml-1">[NoBatch]</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody></table>
                            {% else %}
                                <span class="text-xs text-gray-400 italic">No items recorded.</span>
                            {% endif %}
                        </td>
                        <td class="py-2 px-4 text-left align-top text-xs">
                            {{ parcel.shipped_at|date:"d/m/Y H:i"|default:"Not Picked Up" }}
                        </td>
                        <td class="py-2 px-4 text-left align-top text-xs">
                            {{ parcel.created_at|date:"d/m/Y H:i" }}
                            {% if parcel.created_by %}<br><small class="text-gray-500">by {{parcel.created_by.name|default:parcel.created_by.email|truncatechars:15}}</small>{% endif %}
                        </td>
                        <td class="py-2 px-4 text-left align-top">
                            <a href="#" class="btn btn-xs btn-outline btn-info">View/Edit</a> {# Link to parcel detail/edit page #}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mt-6 rounded-md" role="alert">
        <p class="font-bold">No Parcels Found</p>
        <p>There are currently no parcels matching your criteria. Parcels are created after packing customer orders.</p>
    </div>
{% endif %}
