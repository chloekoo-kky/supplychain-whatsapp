{# app/operation/templates/operation/partials/pack_order_formset.html #}

{{ formset.management_form }}
<table class="table table-xs w-full pack-items-table">
    <thead>
        <tr>
            <th class="w-2/6 py-1 px-1 text-left">Product</th>
            <th class="w-1/6 py-1 px-1 text-center">Qty to Pack</th>
            <th class="w-3/6 py-1 px-1 text-left">Select Batch</th>
            <th class="w-auto p-1"></th> {# For buttons #}
        </tr>
    </thead>
    <tbody id="pack-items-tbody">
        {% for form in formset %}
            {# This row now acts as a template for cloning #}
            <tr class="pack-item-row" data-order-item-id="{{ form.initial.order_item_id }}">
                {# Hidden fields are crucial #}
                {{ form.order_item_id }}
                {{ form.selected_batch_item_id }}

                <td class="py-1 px-1 align-middle">
                    {{ form.initial.product_name }}<br>
                    <span class="text-xs text-gray-500">SKU: {{ form.initial.sku }}</span>
                </td>
                <td class="py-1 px-1 align-middle text-center">
                    {{ form.quantity_to_pack }}

                    {% if form.initial.max_ship_qty_a or form.initial.max_ship_qty_b %}
                        <div class="text-xs text-info mt-1 leading-tight" title="Max Shipping Quantity Limits">
                            <span class="font-semibold">Max Qty:</span><br>
                            {% if form.initial.max_ship_qty_a %}
                                <span>A: {{ form.initial.max_ship_qty_a }}</span>
                            {% endif %}
                            {% if form.initial.max_ship_qty_a and form.initial.max_ship_qty_b %}
                                <span class="mx-1">|</span>
                            {% endif %}
                            {% if form.initial.max_ship_qty_b %}
                                <span>B: {{ form.initial.max_ship_qty_b }}</span>
                            {% endif %}
                        </div>
                    {% endif %}
                </td>
                <td class="py-1 px-1 align-middle relative">
                    {{ form.available_batches }}
                    <div class="text-xs text-error available-batches-error-placeholder mt-0.5"></div>
                </td>
                <td class="py-1 px-1 align-middle text-center">
                    {# Add a plus button to the first row for an item #}
                    <button type="button" class="btn btn-xs btn-ghost add-batch-row-btn" title="Add another batch for this item">+</button>
                </td>
            </tr>
        {% endfor %}
    </tbody>
</table>

<div id="form-template-row" class="hidden">
    {# A clean template for adding new rows via JS. Copy one of the rows from above and paste it here, ensuring its inputs have no values. #}
    {# This is left as an exercise, but you'd copy a full <tr>...</tr> here. #}
</div>
