{% extends 'base.html' %}

{% block title %}Courier Invoices{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-2">
    <div class="flex justify-between items-center mb-3">
        <h1 class="text-3xl font-bold text-gray-800">Courier Invoices</h1>
        <button id="upload-invoice-btn" class="btn btn-primary">
            Upload New Invoice
        </button>
    </div>

    <div class="operations-filter-panel md:w-full shrink-0 sticky top-16 h-fit bg-base-200 shadow px-4 py-3 rounded-lg z-20 mb-4">

        <form id="invoice-filter-form">
            <div class="grid grid-cols-12 gap-2">

                <input type="hidden" name="courier_company" id="id_courier_company_hidden" value="{{ request.GET.courier_company }}">
                <input type="hidden" name="payment_status" id="id_payment_status_hidden" value="{{ request.GET.payment_status }}">
                <input type="hidden" name="warehouse" id="id_warehouse_hidden" value="{{ request.GET.warehouse }}">

                <div class="col-span-12 md:col-span-3 mb-2 md:mr-4">

                    <div id="warehouse-filter-container" class="
                            warehouse-filter-buttons
                            grid gap-2
                            {% if warehouses|length >= 3 %}
                                md:grid-cols-2
                            {% else %}
                                md:flex md:flex-col
                            {% endif %}
                        ">
                        {% if request.user.is_superuser %}
                        {# Superusers see a button for every warehouse #}
                        {% for wh in warehouses %}
                        <button type="button" class="btn btn-sm sm:btn-sm btn-outline {% if request.GET.warehouse == wh.pk|stringformat:'s' %}btn-active{% endif %}" data-value="{{ wh.pk }}">
                            {{ wh.name }}
                        </button>
                        {% endfor %}
                    {% else %}
                        {# Non-superusers only see their own warehouse #}
                        {% if request.user.warehouse %}
                        <button type="button" class="btn btn-sm md:btn-sm btn-neutral text-white">
                            {{ request.user.warehouse.name }}
                        </button>
                        {% else %}
                        <button type="button" class="btn btn-xs sm:btn-sm btn-error text-white" disabled>
                            No WH Assigned
                        </button>
                        {% endif %}
                    {% endif %}
                    </div>
                </div>

                <div class="col-span-12 md:col-span-5 flex flex-col gap-2">
                    <div class="courier-filter-buttons grid grid-flow-col auto-cols-fr gap-2">
                        {% for courier in all_couriers %}
                            <button type="button" class="btn btn-xs sm:btn-sm btn-outline {% if request.GET.courier_company == courier.pk|stringformat:'s' %}btn-active{% endif %}" data-value="{{ courier.pk }}">{{ courier.name }}</button>
                        {% endfor %}
                    </div>

                    <div class="status-filter-buttons grid grid-flow-col auto-cols-fr gap-2">
                        {% for value, display in payment_status_choices %}
                            <button type="button" class="join-item btn btn-sm btn-outline {% if request.GET.payment_status == value %}btn-active{% endif %}" data-value="{{ value }}">{{ display }}</button>
                        {% endfor %}
                    </div>

                </div>

                <div class="col-span-12 md:col-span-4 flex flex-col gap-2">

                    <div class="grid grid-flow-col auto-cols-fr gap-2 w-full">
                        <input type="text"
                               name="{{ filter_form.q.name }}"
                               value="{{ filter_form.q.value|default:'' }}"
                               placeholder="Invoice Number..."
                               class="input input-bordered input-sm w-full"
                               id="{{ filter_form.q.id_for_label }}">
                    </div>

                    <div class="grid grid-flow-col auto-cols-fr gap-2">
                        <button type="reset" id="reset-invoice-filters" class="btn btn-sm btn-outline bg-gray-300 w-full">
                            Reset Filters
                        </button>
                    </div>

                </div>

            </div>
        </form>
        </div>

    <div id="invoice-list-container">
        {% include 'operation/partials/_courier_invoice_list_content.html' with invoices=invoices %}
    </div>
</div>
<!-- Upload Invoice Modal -->
<div id="uploadModal" class="fixed z-50 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
    <div class="js-modal-panel inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
      <form action="{% url 'operation:courier_invoice_list' %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Upload Courier Invoice</h3>
            <div class="mt-4 grid grid-cols-1 gap-6">

                {# This field is now included. It will be a dropdown for superusers #}
                {# and a hidden input for regular warehouse operators. #}
                {% if request.user.is_superuser %}
                <div>
                    <label for="{{ form.warehouse.id_for_label }}" class="block text-sm font-medium text-gray-700">Warehouse</label>
                    {{ form.warehouse }}
                </div>
                {% else %}
                    {{ form.warehouse }}
                {% endif %}
                <div>
                    <label for="{{ form.courier_company.id_for_label }}" class="block text-sm font-medium text-gray-700">Courier Company</label>
                    {{ form.courier_company }}
                </div>
                <div>
                    <label for="{{ form.invoice_file.id_for_label }}" class="block text-sm font-medium text-gray-700">Invoice File (.csv or .xlsx)</label>
                    {{ form.invoice_file }}
                </div>
            </div>
        </div>
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
            Upload & Parse
          </button>
          <button type="button" onclick="closeUploadModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Payment Date Modal -->
<div id="paymentModal" class="fixed z-50 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
    <div class="js-modal-panel inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
      <form id="paymentForm" method="POST">
        {% csrf_token %}
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Update Payment Date</h3>
          <div class="mt-4">
            <label for="payment_date" class="block text-sm font-medium text-gray-700">Payment Date</label>
            <input type="date" name="payment_date" id="payment_date" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
          </div>

          <div class="form-control w-full mt-4">
            <label class="label"><span class="label-text">Payment Amount</span></label>
            <input type="number" step="0.01" name="payment_amount" id="payment-amount-input" class="input input-bordered w-full" />
            <label class="label">
                <span class="label-text-alt">Invoice Total: <strong id="modal-invoice-amount">0.00</strong></span>
            </label>
        </div>

        </div>
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
            Save
          </button>
          <button type="button" onclick="closePaymentModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Script section with click-outside logic (No changes) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Element References ---
    const uploadModal = document.getElementById('uploadModal');
    const paymentModal = document.getElementById('paymentModal');
    const paymentForm = document.getElementById('paymentForm');
    const paymentModalTitle = document.getElementById('modal-title');
    const paymentDateInput = document.getElementById('payment_date');
    const paymentAmountInput = document.getElementById('payment-amount-input');
    const modalInvoiceAmountSpan = document.getElementById('modal-invoice-amount');
    const listContainer = document.getElementById('invoice-list-container');
    const filterForm = document.getElementById('invoice-filter-form');
    const searchInput = filterForm.querySelector('input[name="q"]');
    const uploadBtn = document.getElementById('upload-invoice-btn');
    let searchTimeout;

    // --- Modal Control Functions ---
    function openUploadModal() {
        if (uploadModal) uploadModal.classList.remove('hidden');
    }
    function closeUploadModal() {
        if (uploadModal) uploadModal.classList.add('hidden');
    }
    function closePaymentModal() {
        if (paymentModal) paymentModal.classList.add('hidden');
    }

    function openAndPopulatePaymentModal(button) {
        const invoiceId = button.dataset.invoiceId;
        const invoiceNumber = button.dataset.invoiceNumber;
        const paymentDate = button.dataset.paymentDate;
        const invoiceAmount = button.dataset.invoiceAmount;
        const paymentAmount = button.dataset.paymentAmount;

        paymentForm.action = `/operation/invoices/${invoiceId}/edit/`;
        paymentModalTitle.textContent = `Update Payment for Invoice #${invoiceNumber}`;
        paymentDateInput.value = paymentDate;
        modalInvoiceAmountSpan.textContent = `RM ${invoiceAmount}`;
        paymentAmountInput.value = paymentAmount || invoiceAmount;
        paymentModal.classList.remove('hidden');
    }

    // --- Event Listeners Setup ---
    if (uploadBtn) {
        uploadBtn.addEventListener('click', openUploadModal);
    }

    // Delegated listener for dynamically loaded content in the table
    if (listContainer) {
        listContainer.addEventListener('click', e => {
            const editButton = e.target.closest('.js-edit-payment');
            if (editButton) {
                openAndPopulatePaymentModal(editButton);
            }
            const pageButton = e.target.closest('.invoice-page-btn');
            if (pageButton) {
                e.preventDefault();
                const page = pageButton.dataset.page;
                applyFilters(page);
            }
        });
    }

    // Background click handlers for closing modals
    function handleModalBackgroundClick(modalElement, closeFunction) {
        if (!modalElement) return;
        modalElement.addEventListener('click', function (event) {
            if (event.target.closest('.js-modal-panel') === null) {
                closeFunction();
            }
        });
        const closeButtons = modalElement.querySelectorAll('[onclick*="close"], .js-modal-close');
        closeButtons.forEach(btn => btn.addEventListener('click', closeFunction));
    }
    handleModalBackgroundClick(uploadModal, closeUploadModal);
    handleModalBackgroundClick(paymentModal, closePaymentModal);

    // --- Filter Logic ---
    function applyFilters(page = 1) {
        const formData = new FormData(filterForm);
        const params = new URLSearchParams(formData);
        params.set('page', page);
        history.pushState(null, '', `?${params.toString()}`);
        fetch(`{% url 'operation:courier_invoice_list' %}?${params.toString()}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.text())
        .then(html => {
            if (listContainer) listContainer.innerHTML = html;
        });
    }

    function setupFilterButtons(containerSelector, hiddenInputId) {
        const container = document.querySelector(containerSelector);
        const hiddenInput = document.getElementById(hiddenInputId);
        if (!container || !hiddenInput) return;
        container.addEventListener('click', e => {
            if (e.target.tagName === 'BUTTON') {
                const value = e.target.dataset.value;
                hiddenInput.value = value;
                container.querySelectorAll('.btn').forEach(btn => btn.classList.remove('btn-active'));
                e.target.classList.add('btn-active');
                applyFilters();
            }
        });
    }
    setupFilterButtons('.courier-filter-buttons', 'id_courier_company_hidden');
    setupFilterButtons('.status-filter-buttons', 'id_payment_status_hidden');
    setupFilterButtons('.warehouse-filter-buttons', 'id_warehouse_hidden');

    if (searchInput) {
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => applyFilters(), 300);
        });
    }

    if (filterForm) {
        filterForm.addEventListener('submit', e => {
            e.preventDefault();
            applyFilters();
        });

        const resetBtn = filterForm.querySelector('#reset-invoice-filters');
        if (resetBtn) {
            resetBtn.addEventListener('click', (e) => {
                e.preventDefault();
                filterForm.reset();
                if (searchInput) {
                    searchInput.value = '';
                }
                document.getElementById('id_courier_company_hidden').value = '';
                document.getElementById('id_payment_status_hidden').value = '';
                document.getElementById('id_warehouse_hidden').value = '';


                document.querySelectorAll('.courier-filter-buttons .btn, .status-filter-buttons .btn, .warehouse-filter-buttons .btn').forEach(btn => {
                    btn.classList.remove('btn-active');
                });
                const allCourierBtn = document.querySelector('.courier-filter-buttons .btn[data-value=""]');
                if(allCourierBtn) allCourierBtn.classList.add('btn-active');

                applyFilters();
            });
        }
    }
});
</script>

{% endblock %}
