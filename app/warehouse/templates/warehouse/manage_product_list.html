{% extends "base.html" %}
{% load static %}

{% block title %}
  Manage Product Details
{% endblock %}

{% block content %}
<div class="container mx-auto p-4 md:p-6">
    <div class="prose mb-6">
      <h1>Select a Product to Manage</h1>
      <p class="lead">Here you can update photos, dimensions, and shipping quantities for products in your warehouse.</p>
    </div>

    <div class="mb-6 flex justify-between items-center">
        <div class="form-control max-w-lg">
            <input type="text" id="product-search-input" name="q" placeholder="Type to search by product name or SKU..." class="input input-bordered" value="{{ search_query }}">
        </div>
        <div>
            <button id="export-selected-btn" class="btn btn-secondary" disabled>Export Selected (<span id="selected-count">0</span>)</button>
        </div>
    </div>

    <div id="product-list-container">
        {% include 'warehouse/_manage_product_list_partial.html' %}
    </div>
</div>

<dialog id="manage_modal" class="modal">
  <div class="modal-box w-11/12 max-w-5xl">
    <form method="dialog">
      <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
    </form>
    <div id="modal_content_target">
      </div>
  </div>
</dialog>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('manage_modal');
        const listContainer = document.getElementById('product-list-container');
        const searchInput = document.getElementById('product-search-input');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        let debounceTimer;

        const exportButton = document.getElementById('export-selected-btn');
        const selectedCountSpan = document.getElementById('selected-count');

        // ++ This Set will store selected IDs across all pages ++
        let selectedProductIds = new Set();

        // --- Function to open the modal ---
        async function openManageModal(wpId) {
            const modalContent = document.getElementById('modal_content_target');
            modalContent.innerHTML = '<div class="text-center p-20"><span class="loading loading-spinner loading-lg"></span></div>';
            modal.showModal();
            const url = `/warehouse/product/${wpId}/manage/`;
            try {
                const response = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                if (!response.ok) throw new Error(`Network response was not ok. Status: ${response.status}`);
                modalContent.innerHTML = await response.text();
            } catch (error) {
                modalContent.innerHTML = '<p class="text-error text-center">Failed to load product details. Please try again.</p>';
                console.error('Error fetching form:', error);
            }
        }

        // --- Function to update UI based on selections ---
        function updateSelectionUI() {
            const allVisibleCheckboxes = listContainer.querySelectorAll('.product-checkbox');
            const selectAllCheckbox = listContainer.querySelector('#select-all-checkbox');

            // Restore checked state for visible checkboxes
            allVisibleCheckboxes.forEach(cb => {
                cb.checked = selectedProductIds.has(cb.value);
            });

            // Update "select all" checkbox state
            const allVisibleAreChecked = allVisibleCheckboxes.length > 0 && Array.from(allVisibleCheckboxes).every(cb => cb.checked);
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = allVisibleAreChecked;
                selectAllCheckbox.indeterminate = !allVisibleAreChecked && Array.from(allVisibleCheckboxes).some(cb => cb.checked);
            }

            // Update export button and count
            const count = selectedProductIds.size;
            selectedCountSpan.textContent = count;
            exportButton.disabled = count === 0;
        }

        // --- Function to fetch and update the product list ---
        function fetchProductList(url) {
            listContainer.innerHTML = '<div class="text-center p-20"><span class="loading loading-spinner loading-lg"></span></div>';
            fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(response => response.text())
                .then(html => {
                    listContainer.innerHTML = html;
                    updateSelectionUI(); // Restore selections after new content is loaded
                })
                .catch(error => {
                    listContainer.innerHTML = '<p class="text-error text-center">Could not load search results.</p>';
                    console.error('Error fetching search results:', error);
                });
        }

        // --- Event Listeners ---

        // 1. For dynamic search input
        searchInput.addEventListener('input', function(event) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const query = event.target.value;
                const url = `{% url 'warehouse:manage_product_list' %}?q=${encodeURIComponent(query)}`;
                history.pushState({path: url}, '', url);
                fetchProductList(url);
            }, 300);
        });

        // 2. For clicks within the list container (delegated)
        listContainer.addEventListener('click', function(event) {
            const manageButton = event.target.closest('.js-manage-btn');
            const paginationLink = event.target.closest('.btn-group a.btn');

            if (manageButton) {
                openManageModal(manageButton.dataset.wpid);
            } else if (paginationLink) {
                event.preventDefault();
                const url = paginationLink.href;
                history.pushState({path: url}, '', url);
                fetchProductList(url);
            }

            // Handle 'Select All' checkbox click
            if (event.target.id === 'select-all-checkbox') {
                const isChecked = event.target.checked;
                listContainer.querySelectorAll('.product-checkbox').forEach(cb => {
                    if (isChecked) {
                        selectedProductIds.add(cb.value);
                    } else {
                        selectedProductIds.delete(cb.value);
                    }
                });
                updateSelectionUI();
            }

            // Handle individual checkbox click
            if (event.target.classList.contains('product-checkbox')) {
                const checkbox = event.target;
                if (checkbox.checked) {
                    selectedProductIds.add(checkbox.value);
                } else {
                    selectedProductIds.delete(checkbox.value);
                }
                updateSelectionUI();
            }
        });

        // 3. Export button click listener
        exportButton.addEventListener('click', function() {
            if (selectedProductIds.size > 0) {
                const ids = Array.from(selectedProductIds).join(',');
                const url = `{% url 'warehouse:export_price_list' %}?ids=${ids}`;
                window.open(url, '_blank');
            }
        });

        // Initialize UI on first load
        updateSelectionUI();

        // Other modal listeners remain the same...
        modal.addEventListener('click', function(event) {
            if (event.target === modal) { modal.close(); return; }
            const marginButton = event.target.closest('.js-margin-btn');
            if (marginButton) {
                const unitPriceEl = modal.querySelector('#unit-price'), currencyRateEl = modal.querySelector('#currency_rate'), sellingPriceEl = modal.querySelector('input[name="suggested_selling_price"]');
                if (!unitPriceEl || !currencyRateEl || !sellingPriceEl) { console.error('Pricing calculator elements not found.'); return; }
                const margin = parseFloat(marginButton.dataset.margin), unitPrice = parseFloat(unitPriceEl.value), currencyRate = parseFloat(currencyRateEl.value);
                if (isNaN(unitPrice) || unitPrice <= 0) { unitPriceEl.classList.add('input-error'); setTimeout(() => unitPriceEl.classList.remove('input-error'), 1000); return; }
                if (!isNaN(currencyRate)) { const priceWithMargin = unitPrice * (1 + margin), convertedPrice = priceWithMargin * currencyRate; sellingPriceEl.value = convertedPrice.toFixed(2); }
            }
        });
        modal.addEventListener('input', function(event){
            if(event.target.id === 'currency_rate'){
                const unitPriceEl = modal.querySelector('#unit-price'), currencyRateEl = event.target, sellingPriceEl = modal.querySelector('input[name="suggested_selling_price"]');
                const unitPrice = parseFloat(unitPriceEl.value), currencyRate = parseFloat(currencyRateEl.value);
                if (!isNaN(unitPrice) && !isNaN(currencyRate)) { const convertedPrice = unitPrice * currencyRate; sellingPriceEl.value = convertedPrice.toFixed(2); }
            }
        });
        modal.addEventListener('submit', async function(event) {
            if (event.target.id === 'product-details-form') {
                event.preventDefault();
                const form = event.target; const formData = new FormData(form);
                try {
                    const response = await fetch(form.action, { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken }});
                    const data = await response.json();
                    if (data.success) {
                        modal.close();
                        const currentUrl = window.location.search;
                        fetchProductList(`{% url 'warehouse:manage_product_list' %}${currentUrl}`);
                    } else { document.getElementById('modal_content_target').innerHTML = data.form_html; }
                } catch (error) { console.error('Error submitting form:', error); }
            }
        });
    });
</script>
{% endblock %}
