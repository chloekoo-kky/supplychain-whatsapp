{# Sticky Filter Panel - Refactored to a 12-column grid layout #}
<div class="warehouseproduct-filter sticky top-8 md:top-24 bg-base-200 shadow px-4 py-2 rounded-lg z-40 mb-4">
  <div class="grid grid-cols-12 gap-2">
    {# --- ROW 1: Filters and Buttons --- #}

        {# Total Products Count - 2 columns #}
        <div class="col-span-12 md:col-span-1 items-start">
          <h2 class="text-lg text-gray-700">
            <span id="product-count-display" class="font-bold text-xl">{{ products.paginator.count|default:0 }}</span>
            <span class="font-normal text-gray-500">products</span>
            </h2>
        </div>

        {# Warehouse Filters - 2 columns #}
        <div class="col-span-12 md:col-span-2 md:mr-6">
          {# This container now uses conditional classes for the layout #}
          <div class="
              grid gap-2
              {% if user.is_superuser and warehouses|length >= 3 %}
                  md:grid-cols-2
              {% else %}
                  md:flex md:flex-col
              {% endif %}
          ">
                {% if user.is_superuser %}
                    {% for w_obj in warehouses %}
                    <button type="button" class="btn btn-sm sm:btn-sm btn-outline" data-filter="warehouse" data-value="{{ w_obj.id }}">
                        {{ w_obj.name }}
                    </button>
                    {% endfor %}
                {% else %}
                    {% if user.warehouse %}
                        <button type="button" class="btn btn-sm md:btn-sm btn-neutral text-white">{{ user.warehouse.name }}</button>
                        <input type="hidden" id="user-assigned-warehouse-id" value="{{ user.warehouse.id }}">
                    {% else %}
                        <button type="button" class="btn btn-sm md:btn-sm btn-neutral text-white" disabled>No Warehouse Assigned</button>
                    {% endif %}
                {% endif %}
          </div>
        </div>

        {# Supplier Filters - 5 columns #}
        <div class="col-span-12 md:col-span-7 flex flex-col gap-2 md:mr-8">
            <div class="grid grid-flow-col auto-cols-fr gap-2">
                {% for s_obj in suppliers %}
                <button type="button" class="btn btn-sm btn-outline" data-filter="supplier" data-value="{{ s_obj.id }}">
                    {{ s_obj.code }}
                </button>
                {% endfor %}
            </div>

            <div class="flex items-center gap-2">
              <form id="warehouse-search-form" method="get" action="{% url 'warehouse:search' %}" class="w-full">
                  <input type="text" name="q" placeholder="Search SKU or Product Name" class="input input-sm input-bordered w-[80%]" value="{{ query|default:'' }}" />
                  <button type="button" class="btn btn-sm btn-outline bg-gray-300 w-[18%]" onclick="resetWarehouseProductFilters()">
                      Reset Filters
                  </button>
              </form>
          </div>
        </div>

        {# Action Buttons - 2 columns #}
        <div class="col-span-12 md:col-span-2 flex flex-col gap-2">
          <div class="flex items-center gap-2">
              <label class="label text-sm">H. Lvl:</label>
              <select id="healthy-level" class="select select-sm select-bordered w-32">
                  <option value="1.2">1.2x</option>
                  <option value="1.3">1.3x</option>
                  <option value="1.4">1.4x</option>
                  <option value="1.5" selected>1.5x</option>
              </select>
          </div>
          <div class="flex items-center gap-2">
                {% if user.is_superuser %}
                    <button id="create-po-btn" class="btn btn-sm bg-white hover:bg-gray-400 hover:border-gray-900 hover:text-white text-gray-700 border-gray-900 w-full">
                        Create PO
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{# Main Product Table #}
<table class="table w-full">
  <thead>
      <tr>
          <th><input type="checkbox" id="select-all" class="checkbox checkbox-sm"></th>
          <th>Product</th>
          <th>Supplier</th>
          <th>Warehouse</th>
          <th class="text-right">Threshold</th>
          <th class="text-right">Stock / H. Lvl</th>
          <th id="gap-header" class="text-right cursor-pointer">Gap</th>
          <th>Incoming PO</th>
          <th>Stats</th>

      </tr>
  </thead>
  <tbody id="search-results">
      {% include "warehouse/_warehouse_product_rows.html" with products=products %}
  </tbody>
</table>

<input type="checkbox" id="stats-modal" class="modal-toggle" />
<div class="modal">
  <div class="modal-box w-11/12 max-w-4xl">
    <h3 class="font-bold text-lg" id="stats-modal-title">Statistics</h3>
    <div id="stats-modal-content" class="py-4">
        <div class="text-center">
            <span class="loading loading-lg loading-spinner"></span>
        </div>
    </div>
    <div class="modal-action">
      <label for="stats-modal" class="btn">Close</label>
    </div>
  </div>
</div>

{% if user.is_superuser %}
<input type="checkbox" id="create-po-modal" class="modal-toggle" />
<div class="modal">
  <div class="modal-box w-11/12 max-w-5xl">
    <h3 class="font-bold text-lg mb-4">ðŸ“‘ Confirm Create Purchase Orders</h3>
    <div id="create-po-modal-content" class="space-y-6"></div>
    <div class="modal-action">
      <button type="button" class="btn btn-sm" onclick="document.getElementById('create-po-modal').checked=false">Cancel</button>
      <button id="confirm-create-po" class="btn btn-sm btn-primary">Confirm</button>
    </div>
  </div>
</div>
{% endif %}

<div id="product-modals-container">
  {% include "warehouse/_warehouse_product_modals.html" with products=products today=today %}
</div>
