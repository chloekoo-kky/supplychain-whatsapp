{% comment %} This template ONLY renders the modals for a list of POs. {% endcomment %}
{% load custom_filters %}

{% for po in purchase_orders %}
    <input type="checkbox" id="modal-update-po-{{ po.id }}" class="modal-toggle" />
    <div class="modal">
        <div class="modal-box max-w-lg" data-po-id="{{ po.id }}">
            <h3 class="font-bold text-lg mb-4">Update Purchase Order #{{ po.id }}</h3>
            <form method="post" action="{% url 'warehouse:po_update' po.id %}" class="po-update-form" data-po-id="{{ po.id }}">
                {% csrf_token %}
                <div class="form-control mb-6">
                    <label class="label font-bold">ETA</label>
                    <input type="date" name="eta" value="{{ po.eta|date:'Y-m-d' }}" class="input input-bordered w-full" />
                </div>
                <h3 class="font-bold text-lg mb-4">Update PO Status</h3>
                <input type="hidden" name="selected_status" id="selected-status-{{ po.id }}" value="{{ po.status|default:'' }}">
                <ul class="steps steps-vertical w-full">
                    {% for code, label in status_choices %}
                        {% with po_status_dates=status_dates|get_item:po.id %}
                            {% with status_date=po_status_dates|get_item:code %}
                                <li data-status="{{ code }}" class="step status-step {% if status_date %}step-primary{% else %}cursor-pointer{% endif %}">
                                    <div class="text-left p-2">
                                        <div class="font-semibold">{{ label }}</div>
                                        {% if status_date %}
                                            <div class="text-xs opacity-70">{{ status_date|date:"d M Y, P" }}</div>
                                        {% else %}
                                             <div class="text-xs opacity-50">Click to update</div>
                                        {% endif %}
                                    </div>
                                </li>
                            {% endwith %}
                        {% endwith %}
                    {% endfor %}
                </ul>
                <div class="modal-action mt-6">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <label for="modal-update-po-{{ po.id }}" class="btn btn-outline">Cancel</label>
                </div>
            </form>
        </div>
        <label class="modal-backdrop" for="modal-update-po-{{ po.id }}">Close</label>
    </div>


    {% if request.user.is_superuser %}
    <input type="checkbox" id="modal-edit-items-{{ po.id }}" class="modal-toggle" />
    <div class="modal">
        <div class="modal-box max-w-3xl" data-po-id="{{ po.id }}">
            <h3 class="font-bold text-lg mb-4">Edit Items for PO-{{ po.id }}</h3>
            <form method="post" action="{% url 'warehouse:po_edit_items' po.id %}" class="po-edit-form" data-po-id="{{ po.id }}">
                {% csrf_token %}
                <div class="overflow-x-auto">
                    <table class="table w-full mb-4">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Unit Price (USD)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in po.items.all %}
                            <tr>
                                <input type="hidden" name="item_id_{{ forloop.counter0 }}" value="{{ item.id }}">
                                <input type="hidden" name="product_{{ forloop.counter0 }}" value="{{ item.item.id }}">
                                <td>{{ item.item.product.sku|default:"-" }}</td>
                                <td>{{ item.item.product.name|default:"-" }}</td>
                                <td><input type="number" name="quantity_{{ forloop.counter0 }}" value="{{ item.quantity|default:0 }}" class="input input-sm input-bordered w-24" /></td>
                                <td><input type="number" step="0.01" name="price_{{ forloop.counter0 }}" value="{{ item.price|floatformat:2 }}" class="input input-sm input-bordered w-24" /></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="modal-action justify-between">
                    <label for="modal-edit-items-{{ po.id }}" class="btn">Cancel</label>
                    <div>
                        <button type="button" class="btn btn-outline delete-po-btn" data-po-id="{{ po.id }}">Delete PO</button>

                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </div>
            </form>
        </div>
        <label class="modal-backdrop" for="modal-edit-items-{{ po.id }}">Close</label>
    </div>
    {% endif %}

    {% endfor %}
