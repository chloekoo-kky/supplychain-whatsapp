{% comment %}
This partial iterates through batch items and creates a modal for each,
allowing the 'location_label', 'cost_price' (for superusers), and default pick status to be edited.
It includes other required fields as hidden inputs to ensure form validation passes.
{% endcomment %}

{% for batch_item_modal_instance in all_inventory_batches %}
    <input type="checkbox" id="edit-batch-modal-toggle-{{ batch_item_modal_instance.pk }}" class="modal-toggle edit-batch-modal-checkbox-actual" />
    <div class="modal edit-batch-modal-instance" id="edit-batch-modal-container-{{ batch_item_modal_instance.pk }}" role="dialog">
        <div class="modal-box max-w-lg">
            <form class="edit-batch-form" method="POST" action="{% url 'inventory:edit_inventory_batch' batch_item_modal_instance.pk %}">
                {% csrf_token %}

                {# Hidden fields to pass validation on the backend #}
                <input type="hidden" name="warehouse_product" value="{{ batch_item_modal_instance.warehouse_product.pk }}">
                <input type="hidden" name="batch_number" value="{{ batch_item_modal_instance.batch_number|default_if_none:'' }}">
                <input type="hidden" name="quantity" value="{{ batch_item_modal_instance.quantity }}">
                <input type="hidden" name="date_received" value="{{ batch_item_modal_instance.date_received|date:'Y-m-d' }}">
                {% if batch_item_modal_instance.expiry_date %}
                <input type="hidden" name="expiry_date" value="{{ batch_item_modal_instance.expiry_date|date:'Y-m-d' }}">
                {% endif %}

                <h3 class="font-bold text-xl mb-4">Edit Batch Details</h3>

                <div class="mb-4 bg-base-200 p-3 rounded-lg text-sm">
                    <p><span class="font-semibold">Product:</span> {{ batch_item_modal_instance.warehouse_product.product.name }}</p>
                    <p><span class="font-semibold">SKU:</span> {{ batch_item_modal_instance.warehouse_product.product.sku }}</p>
                    <p><span class="font-semibold">Warehouse:</span> {{ batch_item_modal_instance.warehouse_product.warehouse.name }}</p>
                </div>

                <div class="form-control w-full mb-4">
                    <label class="label" for="id_location_label_edit_{{ batch_item_modal_instance.pk }}">
                        <span class="label-text font-semibold">Location Label</span>
                    </label>
                    <input type="text" name="location_label" id="id_location_label_edit_{{ batch_item_modal_instance.pk }}" value="{{ batch_item_modal_instance.location_label|default_if_none:'' }}" placeholder="Enter Location Label" class="input input-bordered w-full" />
                </div>

                {% if user.is_superuser %}
                <div class="form-control w-full mb-4">
                    <label class="label" for="id_cost_price_edit_{{ batch_item_modal_instance.pk }}">
                        <span class="label-text font-semibold">Cost Price (per unit)</span>
                    </label>
                    <input type="number" name="cost_price" id="id_cost_price_edit_{{ batch_item_modal_instance.pk }}" value="{{ batch_item_modal_instance.cost_price|stringformat:'.2f'|default_if_none:'' }}" step="0.01" placeholder="e.g., 10.50" class="input input-bordered w-full" />
                </div>
                {% else %}
                    <input type="hidden" name="cost_price" value="{{ batch_item_modal_instance.cost_price|stringformat:'.2f'|default_if_none:'' }}">
                {% endif %}

                {# "Set as Default Pick" Checkbox #}
                <div class="form-control w-full mb-2 p-1 bg-blue-50 border border-blue-200 rounded-lg">
                    <label class="label cursor-pointer justify-start">
                        <input type="checkbox" name="set_as_default_pick" class="checkbox checkbox-primary mr-3" {% if batch_item_modal_instance.pick_priority == 0 %}checked{% endif %} />
                        <span class="label-text font-semibold text-blue-800">Set as Default Pick Location</span>
                    </label>
                    <p class="text-xs text-gray-500 mt-1 ml-9">Checking this will make it the primary location for picking this product. Any other default pick for this product will be unset.</p>
                </div>

                <div class="mt-6 border-t pt-4">
                    <h4 class="font-semibold text-md mb-2 text-gray-600">Batch Details (Read-Only)</h4>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                        <div>
                            <p class="font-medium text-gray-500">Batch Number</p>
                            <p class="font-mono p-1">{{ batch_item_modal_instance.batch_number|default:"N/A" }}</p>
                        </div>
                        <div>
                            <p class="font-medium text-gray-500">Quantity</p>
                            <p class="font-mono p-1">{{ batch_item_modal_instance.quantity }}</p>
                        </div>
                        <div>
                            <p class="font-medium text-gray-500">Expiry Date</p>
                            <p class="font-mono p-1">{{ batch_item_modal_instance.expiry_date|date:"Y-m-d"|default:"N/A" }}</p>
                        </div>
                        <div>
                            <p class="font-medium text-gray-500">Date Received</p>
                            <p class="font-mono p-1">{{ batch_item_modal_instance.date_received|date:"Y-m-d" }}</p>
                        </div>
                    </div>
                </div>

                <div class="modal-action mt-8">
                    <label for="edit-batch-modal-toggle-{{ batch_item_modal_instance.pk }}" class="btn btn-ghost">Cancel</label>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
        <label class="modal-backdrop" for="edit-batch-modal-toggle-{{ batch_item_modal_instance.pk }}">Close</label>
    </div>
{% endfor %}
