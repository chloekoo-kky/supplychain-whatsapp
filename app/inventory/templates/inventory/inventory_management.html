{% extends 'base.html' %}
{% load static %}

{% block content %}


<!-- Tabs 导航 -->
<div class="tabs mb-4 px-4">
  <a href="?tab=products"
    class="tab tab-lifted text-lg transition {% if active_tab == 'products' %}bg-blue-500 text-white{% else %}bg-gray-200 hover:bg-gray-300 text-gray-700{% endif %}">
    Product
  </a>

  <a href="?tab=suppliers"
    class="tab tab-lifted text-lg transition {% if active_tab == 'suppliers' %}bg-blue-500 text-white{% else %}bg-gray-200 hover:bg-gray-300 text-gray-700{% endif %}">
    Suppliers
  </a>
</div>
<!-- 内容区域：默认通过包含相应局部模板加载当前 tab 的数据 -->
<div id="tab-content">
  {% if active_tab == 'suppliers' %}
  {% include "inventory/supplier_list_partial.html" %}
  {% else %}
  {% include "inventory/inventory_list_partial.html" %}
  {% endif %}
</div>
{% endblock %}


{% block extra_js %}
<script>
  // 为 Tabs 导航绑定点击事件，并通过 Ajax 加载内容
  document.querySelectorAll('.tabs a').forEach(function(tab){
    tab.addEventListener('click', function(e){
      e.preventDefault();
      // 取得带 ?tab= 参数的 URL
      const url = this.getAttribute('href');
      // 更新浏览器 URL，不刷新页面
      history.pushState(null, '', url);

      // Ajax 请求加载对应部分的局部模板
      fetch(url, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.text())
      .then(html => {
        document.getElementById('tab-content').innerHTML = html;
        // 更新 tabs 高亮样式：清除所有 tab 的激活样式，再为当前点击的 tab 添加
        document.querySelectorAll('.tabs a').forEach(function(t){
          t.classList.remove('bg-blue-500', 'text-white');
          t.classList.add('bg-gray-200', 'text-gray-700');
        });
        tab.classList.remove('bg-gray-200', 'text-gray-700');
        tab.classList.add('bg-blue-500', 'text-white');

        // 如果当前加载的是产品 tab，则初始化搜索的 Ajax 绑定
        // 可根据 URL 参数判断，例如：url 中不含 tab=po 或 tab=suppliers，视为 products
        const params = new URLSearchParams(url.split('?')[1]);
        if (!params.get('tab') || params.get('tab') === 'products'){
            initSearchAjax();
        }
      })
      .catch(err => console.error('Error loading content:', err));
    });
  });

  // 搜索功能 Ajax 初始化函数
  function initSearchAjax(){
    const searchForm = document.getElementById("search-form");
    const searchResults = document.getElementById("search-results");
    if (!searchForm) {
      console.error("无法找到 search-form 元素");
      return;
    }
    // 为避免重复绑定，先移除之前的事件监听（如有需要则使用事件委托）
    searchForm.addEventListener("submit", function (e) {
      e.preventDefault();
      const query = searchForm.querySelector("input[name='q']").value;
      console.log("Search triggered with query:", query);
      const url = "{% url 'inventory:search' %}?q=" + encodeURIComponent(query)
      fetch(url, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
      })
      .then(res => res.text())
      .then(html => {
        console.log("Received search results HTML");
        if (searchResults) {
          searchResults.innerHTML = html;
        }
      })
      .catch(err => {
        console.error("Search error:", err);
      });
    });
  }

  // 页面加载后，如果当前页为产品 tab，则初始化搜索事件
  document.addEventListener("DOMContentLoaded", function() {
    if ("{{ active_tab }}" === "products") {
      initSearchAjax();
    }
  });
</script>
{% endblock %}
